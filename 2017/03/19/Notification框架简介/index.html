<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Android," />





  <link rel="alternate" href="/atom.xml" title="Evan-Lam's Blog" type="application/atom+xml" />






<meta name="description" content="目录 Notification介绍 Notification框架原理 Notification框架服务端启动过程 SystemUI进程启动和绑定NotificationManagerService服务端过程 Notification调用过程 Notification通知提示音响起过程 总结  Notification介绍功能作用 显示接收到短息、即时消息等信息 （如QQ、微信、新浪、短信）   显">
<meta name="keywords" content="Android">
<meta property="og:type" content="article">
<meta property="og:title" content="Notification框架简介">
<meta property="og:url" content="https://liangyunfeng.github.io/2017/03/19/Notification框架简介/index.html">
<meta property="og:site_name" content="Evan-Lam&#39;s Blog">
<meta property="og:description" content="目录 Notification介绍 Notification框架原理 Notification框架服务端启动过程 SystemUI进程启动和绑定NotificationManagerService服务端过程 Notification调用过程 Notification通知提示音响起过程 总结  Notification介绍功能作用 显示接收到短息、即时消息等信息 （如QQ、微信、新浪、短信）   显">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://liangyunfeng.github.io/2017/03/19/Notification框架简介/Notification.png">
<meta property="og:image" content="https://liangyunfeng.github.io/2017/03/19/Notification框架简介/模块关系图.png">
<meta property="og:image" content="https://liangyunfeng.github.io/2017/03/19/Notification框架简介/类图.jpg">
<meta property="og:image" content="https://liangyunfeng.github.io/2017/03/19/Notification框架简介/时序图.jpg">
<meta property="og:image" content="https://liangyunfeng.github.io/2017/03/19/Notification框架简介/时序图2.jpg">
<meta property="og:image" content="https://liangyunfeng.github.io/2017/03/19/Notification框架简介/通信图.jpg">
<meta property="og:updated_time" content="2018-05-23T10:37:46.354Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Notification框架简介">
<meta name="twitter:description" content="目录 Notification介绍 Notification框架原理 Notification框架服务端启动过程 SystemUI进程启动和绑定NotificationManagerService服务端过程 Notification调用过程 Notification通知提示音响起过程 总结  Notification介绍功能作用 显示接收到短息、即时消息等信息 （如QQ、微信、新浪、短信）   显">
<meta name="twitter:image" content="https://liangyunfeng.github.io/2017/03/19/Notification框架简介/Notification.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://liangyunfeng.github.io/2017/03/19/Notification框架简介/"/>





  <title>Notification框架简介 | Evan-Lam's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Evan-Lam's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">持之以恒，契而不舍</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://liangyunfeng.github.io/2017/03/19/Notification框架简介/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Evan-Lam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Evan-Lam's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Notification框架简介</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-19T14:45:43+08:00">
                2017-03-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/03/19/Notification框架简介/" class="leancloud_visitors" data-flag-title="Notification框架简介">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ul>
<li>Notification介绍</li>
<li>Notification框架原理</li>
<li>Notification框架服务端启动过程</li>
<li>SystemUI进程启动和绑定NotificationManagerService服务端过程</li>
<li>Notification调用过程</li>
<li>Notification通知提示音响起过程</li>
<li>总结</li>
</ul>
<h1 id="Notification介绍"><a href="#Notification介绍" class="headerlink" title="Notification介绍"></a>Notification介绍</h1><h3 id="功能作用"><a href="#功能作用" class="headerlink" title="功能作用"></a>功能作用</h3><ol>
<li>显示接收到短息、即时消息等信息 （如QQ、微信、新浪、短信）  </li>
<li>显示客户端的推送消息（如有新版本发布，广告，推荐新闻等） </li>
<li>显示正在进行的事务（例如：后台运行的程序）（如音乐播放器、版本更新时候的下载进度等）</li>
</ol>
<h3 id="通知的基本组成"><a href="#通知的基本组成" class="headerlink" title="通知的基本组成"></a>通知的基本组成</h3><img src="/2017/03/19/Notification框架简介/Notification.png" title="Notification">
<pre><code>1. 标题
2. 大图标
3. 内容文字 
4. 内容信息
5. 小图标
6. 通知的时间(Timestamp,默认为系统发出通知的时间，也可通过setWhen()来设置)
</code></pre><h1 id="Notification框架原理"><a href="#Notification框架原理" class="headerlink" title="Notification框架原理"></a>Notification框架原理</h1><p>通知栏框架（Notificaiton），它适用于Android系统中交互事件的通知。它主要由三部分组成：系统服务端NotificationManagerService，通知显示端SystemUI，还有创建和更新通知的App端。<br>NotificationManagerService作为框架的服务端，在系统启动时就会启动并在后台运行，显示端SystemUI作为系统UI进程，也是Notification框架的客户端，在系统启动时也会启动并一直运行。<br>其它模块需调用Notification时，只需要调用NotificationManager.notify(int,Notification)就可以发出通知。</p>
<img src="/2017/03/19/Notification框架简介/模块关系图.png" title="模块关系图">
<p>根据Notification框架的原理，我们就分别按以下几点来分析：</p>
<pre><code>1. Notification框架服务端启动过程
2. SystemUI进程启动和绑定NotificationManagerService服务端过程
3. Notification调用过程
4. Notification通知提示音响起过程
</code></pre><h3 id="Notification框架相关的包"><a href="#Notification框架相关的包" class="headerlink" title="Notification框架相关的包"></a>Notification框架相关的包</h3><pre><code>android/frameworks/base/services/java/com/android/server/SystemServer.java        //系统服务类启动的地方
android/frameworks/base/core/java/com/android/server/LocalServices.java            //系统服务类通信的辅助类
android/frameworks/base/core/java/android/service/notification/                    //Notification服务的接口类和监听类
android/frameworks/base/services/core/java/com/android/server/notification/        //NotificationManagerService服务相关的类
android/frameworks/base/core/java/android/app/        //NotificationManager、Notification类和INotificationManager.aidl的包
android/frameworks/base/packages/SystemUI/                                        //Notification显示的UI进程
</code></pre><h3 id="Notification框架的关系类图"><a href="#Notification框架的关系类图" class="headerlink" title="Notification框架的关系类图"></a>Notification框架的关系类图</h3><img src="/2017/03/19/Notification框架简介/类图.jpg" title="类图">
<h1 id="Notification框架服务端启动过程"><a href="#Notification框架服务端启动过程" class="headerlink" title="Notification框架服务端启动过程"></a>Notification框架服务端启动过程</h1><p>SystemServer启动的Notification管理服务类是NotificationManagerService，保存到SystemServiceManager的是NotificationManagerService服务对象中的INotificationManager.Stub()，但是绑定到ServiceManager中Context.NOTIFICATION_ SERVICE的服务类是NotificationManager，所有开发者通过Context.getSystemService(Context.NOTIFICATION_SERVICE)获取回来的服务类不是NotificationManagerServiced服务对象，而是NotificationManager对象，需要再通过NotificationManager对象中的getService()方法，获取SystemServiceManager系统服务管理对象中保存的INotificationManager.Stub()对象。这样NotificationManager就能通过INotificationManager.Stub()对象和NotificationManagerService服务对象进行远程通信了</p>
<p>系统启动时，SystemServiceRegistry类中会把NotificationManager注册为系统服务提供给其它服务或者应用获取系统服务使用，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">/android/frameworks/base/core/java/android/app/SystemServiceRegistry.java </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> HashMap&lt;Class&lt;?&gt;, String&gt; SYSTEM_SERVICE_NAMES =</span><br><span class="line">		<span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, String&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> HashMap&lt;String, ServiceFetcher&lt;?&gt;&gt; SYSTEM_SERVICE_FETCHERS =</span><br><span class="line">		<span class="keyword">new</span> HashMap&lt;String, ServiceFetcher&lt;?&gt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	registerService(Context.NOTIFICATION_SERVICE, NotificationManager.class,</span><br><span class="line">			<span class="keyword">new</span> CachedServiceFetcher&lt;NotificationManager&gt;() &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> NotificationManager <span class="title">createService</span><span class="params">(ContextImpl ctx)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">final</span> Context outerContext = ctx.getOuterContext();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> NotificationManager(</span><br><span class="line">					<span class="keyword">new</span> ContextThemeWrapper(outerContext,</span><br><span class="line">							Resources.selectSystemTheme(<span class="number">0</span>,</span><br><span class="line">									outerContext.getApplicationInfo().targetSdkVersion,</span><br><span class="line">									com.android.internal.R.style.Theme_Dialog,</span><br><span class="line">									com.android.internal.R.style.Theme_Holo_Dialog,</span><br><span class="line">									com.android.internal.R.style.Theme_DeviceDefault_Dialog,</span><br><span class="line">									com.android.internal.R.style.Theme_DeviceDefault_Light_Dialog)),</span><br><span class="line">					ctx.mMainThread.getHandler());</span><br><span class="line">	&#125;&#125;);</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">registerService</span><span class="params">(String serviceName, Class&lt;T&gt; serviceClass,</span></span></span><br><span class="line"><span class="function"><span class="params">		ServiceFetcher&lt;T&gt; serviceFetcher)</span> </span>&#123;</span><br><span class="line">	SYSTEM_SERVICE_NAMES.put(serviceClass, serviceName);</span><br><span class="line">	SYSTEM_SERVICE_FETCHERS.put(serviceName, serviceFetcher);	<span class="comment">//把注册的服务保存到列表对象中</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getSystemService</span><span class="params">(ContextImpl ctx, String name)</span> </span>&#123;</span><br><span class="line">	ServiceFetcher&lt;?&gt; fetcher = SYSTEM_SERVICE_FETCHERS.get(name);</span><br><span class="line">	<span class="keyword">return</span> fetcher != <span class="keyword">null</span> ? fetcher.getService(ctx) : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Activity或者Service中，可以直接通过Context.getSystemService(Context.NOTIFICATION_SERVICE)就可以获取系统服务使用。ActivityThread.performLaunchActivity()方法中创建ContextImpl对象并通过activity.attach()传递给Activity对象，再通过attachBaseContext()方法赋值给父类ContextWrapper中Context mBase对象，在Activity或者Service中调用getSystemService()方法，最终是调用ContextImpl中的getSystemService()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//android/frameworks/base/core/java/android/app/ContextImpl.java </span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSystemService</span><span class="params">(String name)</span> </span>&#123;					<span class="comment">//从注册到系统的服务列表中获取对应的服务</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	Object registrySystemService = SystemServiceRegistry.getSystemService(<span class="keyword">this</span>, name);</span><br><span class="line">	<span class="keyword">return</span> registrySystemService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SystemServiceRegistry中注册的NotificationManager对象，其实不是真正的Notification服务，它只是一个调用接口对象，需要通过远程调用来实现和NotificationManagerService服务对象进行通信，真正实现相应的操作。以下是NotificationManagerService服务的启动流程。系统启动时会调用SystemServer来启动相应的系统服务对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">/android/frameworks/base/services/java/com/android/server/SystemServer.java </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> SystemServiceManager mSystemServiceManager;										<span class="comment">//系统服务管理类</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="comment">//创建系统服务管理对象</span></span><br><span class="line">	mSystemServiceManager = <span class="keyword">new</span> SystemServiceManager(mSystemContext);</span><br><span class="line">	<span class="comment">//把系统服务管理对象保存到本地服务列表对象中，这样在系统进程中就可以通过LocalServices.getService(Class&lt;T&gt; type)</span></span><br><span class="line">	<span class="comment">//直接返回本地服务列表中的服务对象进行使用</span></span><br><span class="line">	LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	INotificationManager notification = <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	mSystemServiceManager.startService(NotificationManagerService.class);				<span class="comment">//启动NotificationManagerService服务对象</span></span><br><span class="line">	<span class="comment">//获取NotificationManagerService服务对象的桩，用于进行远程调用</span></span><br><span class="line">	notification = INotificationManager.Stub.asInterface(</span><br><span class="line">			ServiceManager.getService(Context.NOTIFICATION_SERVICE));</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/android/frameworks/base/services/core/java/com/android/server/SystemServiceManager.java <span class="comment">//系统服务管理类</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T extends SystemService&gt; <span class="function">T <span class="title">startService</span><span class="params">(Class&lt;T&gt; serviceClass)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> String name = serviceClass.getName();</span><br><span class="line">	<span class="keyword">final</span> T service;</span><br><span class="line"></span><br><span class="line">	Constructor&lt;T&gt; constructor = serviceClass.getConstructor(Context.class);</span><br><span class="line">	service = constructor.newInstance(mContext);	<span class="comment">//实例化服务</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Register it.</span></span><br><span class="line">	mServices.add(service);		<span class="comment">//注册服务</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Start it.</span></span><br><span class="line">	service.onStart();			<span class="comment">//启动服务</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> service;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//系统服务类，NotificationManagerService的父类</span></span><br><span class="line">/android/frameworks/base/services/core/java/com/android/server/SystemService.java 		</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span></span>;		<span class="comment">//抽象方法，在子类中实现</span></span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">publishBinderService</span><span class="params">(String name, IBinder service)</span> </span>&#123;</span><br><span class="line">	publishBinderService(name, service, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">publishBinderService</span><span class="params">(String name, IBinder service,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">boolean</span> allowIsolated)</span> </span>&#123;</span><br><span class="line">	ServiceManager.addService(name, service, allowIsolated);	</span><br><span class="line">&#125;	</span><br><span class="line"></span><br><span class="line"><span class="comment">//绑定和发布key为Context.NOTIFICATION_SERVICE的NotificationManager系统服务类</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">publishLocalService</span><span class="params">(Class&lt;T&gt; type, T service)</span> </span>&#123;</span><br><span class="line">	LocalServices.addService(type, service);</span><br><span class="line">&#125;	</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加到内部系统服务类的集合类LocalServices中</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> SystemServiceManager <span class="title">getManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> LocalServices.getService(SystemServiceManager.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SystemServer中调用NotificationManagerService的onStart()方法来启动NotificationManagerService服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line">/android/frameworks/base/services/core/java/com/android/server/notification/NotificationManagerService.java </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotificationManagerService</span> <span class="keyword">extends</span> <span class="title">SystemService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">		mListeners = <span class="keyword">new</span> NotificationListeners();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//绑定和发布key为Context.NOTIFICATION_SERVICE的NotificationManager系统服务类</span></span><br><span class="line">		publishBinderService(Context.NOTIFICATION_SERVICE, mService);</span><br><span class="line">		<span class="comment">//添加到内部系统服务类的集合类LocalServices中</span></span><br><span class="line">		publishLocalService(NotificationManagerInternal.class, mInternalService);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//只开放给系统内部调用的API</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> NotificationManagerInternal mInternalService = <span class="keyword">new</span> NotificationManagerInternal() &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueueNotification</span><span class="params">(String pkg, String opPkg, <span class="keyword">int</span> callingUid, <span class="keyword">int</span> callingPid,</span></span></span><br><span class="line"><span class="function"><span class="params">				String tag, <span class="keyword">int</span> id, Notification notification, <span class="keyword">int</span>[] idReceived, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">			enqueueNotificationInternal(pkg, opPkg, callingUid, callingPid, tag, id, notification,</span><br><span class="line">					idReceived, userId);</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeForegroundServiceFlagFromNotification</span><span class="params">(String pkg, <span class="keyword">int</span> notificationId,</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">			checkCallerIsSystem();</span><br><span class="line">			<span class="keyword">synchronized</span> (mNotificationList) &#123;</span><br><span class="line">				<span class="keyword">int</span> i = indexOfNotificationLocked(pkg, <span class="keyword">null</span>, notificationId, userId);</span><br><span class="line">				<span class="keyword">if</span> (i &lt; <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				NotificationRecord r = mNotificationList.get(i);</span><br><span class="line">				StatusBarNotification sbn = r.sbn;</span><br><span class="line">				sbn.getNotification().flags = (r.mOriginalFlags &amp; ~Notification.FLAG_FOREGROUND_SERVICE);</span><br><span class="line">				mRankingHelper.sort(mNotificationList);</span><br><span class="line">				mListeners.notifyPostedLocked(sbn, sbn <span class="comment">/* oldSbn */</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//INotificationManager.Stub用于与NotificationManager类和SystemUI进程进行远程通信的桩 (或者其它模块)</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> IBinder mService = <span class="keyword">new</span> INotificationManager.Stub() &#123;</span><br><span class="line">	</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueueNotificationWithTag</span><span class="params">(String pkg, String opPkg, String tag, <span class="keyword">int</span> id,</span></span></span><br><span class="line"><span class="function"><span class="params">				Notification notification, <span class="keyword">int</span>[] idOut, <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">			enqueueNotificationInternal(pkg, opPkg, Binder.getCallingUid(),</span><br><span class="line">					Binder.getCallingPid(), tag, id, notification, idOut, userId);	<span class="comment">//添加或更新Notification</span></span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelNotificationWithTag</span><span class="params">(String pkg, String tag, <span class="keyword">int</span> id, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">			checkCallerIsSystemOrSameApp(pkg);</span><br><span class="line">			userId = ActivityManager.handleIncomingUser(Binder.getCallingPid(),</span><br><span class="line">					Binder.getCallingUid(), userId, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="string">"cancelNotificationWithTag"</span>, pkg);</span><br><span class="line">			cancelNotification(Binder.getCallingUid(), Binder.getCallingPid(), pkg, tag, id, <span class="number">0</span>,</span><br><span class="line">					Binder.getCallingUid() == Process.SYSTEM_UID</span><br><span class="line">					? <span class="number">0</span> : Notification.FLAG_FOREGROUND_SERVICE, <span class="keyword">false</span>, userId, REASON_NOMAN_CANCEL,</span><br><span class="line">					<span class="keyword">null</span>);															<span class="comment">//删除Notification</span></span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelAllNotifications</span><span class="params">(String pkg, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">			checkCallerIsSystemOrSameApp(pkg);</span><br><span class="line">			userId = ActivityManager.handleIncomingUser(Binder.getCallingPid(),</span><br><span class="line">					Binder.getCallingUid(), userId, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="string">"cancelAllNotifications"</span>, pkg);</span><br><span class="line">			cancelAllNotificationsInt(Binder.getCallingUid(), Binder.getCallingPid(),</span><br><span class="line">					pkg, <span class="number">0</span>, Notification.FLAG_FOREGROUND_SERVICE, <span class="keyword">true</span>, userId,</span><br><span class="line">					REASON_NOMAN_CANCEL_ALL, <span class="keyword">null</span>);									<span class="comment">//删除所有Notification</span></span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerListener</span><span class="params">(<span class="keyword">final</span> INotificationListener listener,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">final</span> ComponentName component, <span class="keyword">final</span> <span class="keyword">int</span> userid)</span> </span>&#123;</span><br><span class="line">			enforceSystemOrSystemUI(<span class="string">"INotificationManager.registerListener"</span>);</span><br><span class="line">			<span class="comment">//把NotificationListenerService对象注册到ManagedServices服务管理子类NotificationListeners对象中</span></span><br><span class="line">			mListeners.registerService(listener, component, userid);</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterListener</span><span class="params">(INotificationListener listener, <span class="keyword">int</span> userid)</span> </span>&#123;</span><br><span class="line">			<span class="comment">//把NotificationListenerService对象从ManagedServices服务管理子类NotificationListeners对象中解除</span></span><br><span class="line">			mListeners.unregisterService(listener, userid);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">enqueueNotificationInternal</span><span class="params">(<span class="keyword">final</span> String pkg, <span class="keyword">final</span> String opPkg, <span class="keyword">final</span> <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">final</span> <span class="keyword">int</span> callingPid, <span class="keyword">final</span> String tag, <span class="keyword">final</span> <span class="keyword">int</span> id, <span class="keyword">final</span> Notification notification,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">int</span>[] idOut, <span class="keyword">int</span> incomingUserId)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">		mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">synchronized</span> (mNotificationList) &#123;</span><br><span class="line">					<span class="comment">//...</span></span><br><span class="line">					<span class="comment">//调用服务管理对象mListeners来更新所有注册到mListeners中的NotificationListenerService对象</span></span><br><span class="line">					mListeners.notifyPostedLocked(n, oldSbn);</span><br><span class="line">					<span class="comment">//实现播放notification的铃声，使led灯亮起来或者震动等操作。buzz:嗡嗡叫，beep: 嘟嘟响，blink: 闪烁</span></span><br><span class="line">					buzzBeepBlinkLocked(r);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		idOut[<span class="number">0</span>] = id;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//ManagedServices服务管理类，就是用于一类服务的管理对象，例如:如需要管理几个同一类的服务对象NotificationListenerService</span></span><br><span class="line">	<span class="comment">//只需要把相关的NotificationListenerService对象注册到ManagedServices服务管理对象中，需要更新的时候，只需要调用</span></span><br><span class="line">	<span class="comment">//ManagedServices服务管理对象对注册的NotificationListenerService对象进行更新即可</span></span><br><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotificationListeners</span> <span class="keyword">extends</span> <span class="title">ManagedServices</span> </span>&#123;	</span><br><span class="line">	</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">NotificationListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">super</span>(getContext(), mHandler, mNotificationList, mUserProfiles);</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> IInterface <span class="title">asInterface</span><span class="params">(IBinder binder)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> INotificationListener.Stub.asInterface(binder);</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="comment">//新添加的方法，调用这个方法，就会更新所有注册进来的NotificationListenerService对象来更新</span></span><br><span class="line">		<span class="comment">//调用服务管理对象mListeners来更新所有注册到mListeners中的NotificationListenerService对象</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyPostedLocked</span><span class="params">(StatusBarNotification sbn, StatusBarNotification oldSbn)</span> </span>&#123;</span><br><span class="line">			StatusBarNotification sbnClone = <span class="keyword">null</span>;</span><br><span class="line">			StatusBarNotification sbnCloneLight = <span class="keyword">null</span>;</span><br><span class="line">	</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">final</span> ManagedServiceInfo info : mServices) &#123;</span><br><span class="line">				<span class="comment">//...</span></span><br><span class="line">				<span class="keyword">if</span> (trim == TRIM_LIGHT &amp;&amp; sbnCloneLight == <span class="keyword">null</span>) &#123;</span><br><span class="line">					sbnCloneLight = sbn.cloneLight();</span><br><span class="line">	          	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (trim == TRIM_FULL) &#123;</span><br><span class="line">					sbnClone = sbn.clone();</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">final</span> StatusBarNotification sbnToPost =</span><br><span class="line">						(trim == TRIM_FULL) ? sbnClone : sbnCloneLight;</span><br><span class="line">	</span><br><span class="line">				mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">					<span class="meta">@Override</span></span><br><span class="line">					<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">						notifyPosted(info, sbnToPost, update);	<span class="comment">//调用更新通知方法</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyRemovedLocked</span><span class="params">(StatusBarNotification sbn)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">final</span> StatusBarNotification sbnLight = sbn.cloneLight();</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">final</span> ManagedServiceInfo info : mServices) &#123;</span><br><span class="line">				<span class="keyword">final</span> NotificationRankingUpdate update = makeRankingUpdateLocked(info);</span><br><span class="line">				mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">					<span class="meta">@Override</span></span><br><span class="line">					<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">						notifyRemoved(info, sbnLight, update);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//调用更新通知方法</span></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyPosted</span><span class="params">(<span class="keyword">final</span> ManagedServiceInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="keyword">final</span> StatusBarNotification sbn, NotificationRankingUpdate rankingUpdate)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">final</span> INotificationListener listener = (INotificationListener)info.service;</span><br><span class="line">			StatusBarNotificationHolder sbnHolder = <span class="keyword">new</span> StatusBarNotificationHolder(sbn);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="comment">//回调NotificationListenerService对象中的方法onNotificationPosted()，在SystemUI中显示Notification</span></span><br><span class="line">				listener.onNotificationPosted(sbnHolder, rankingUpdate);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">				Log.e(TAG, <span class="string">"unable to notify listener (posted): "</span> + listener, ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyRemoved</span><span class="params">(ManagedServiceInfo info, StatusBarNotification sbn,</span></span></span><br><span class="line"><span class="function"><span class="params">				NotificationRankingUpdate rankingUpdate)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (!info.enabledAndUserMatches(sbn.getUserId())) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">final</span> INotificationListener listener = (INotificationListener) info.service;</span><br><span class="line">			StatusBarNotificationHolder sbnHolder = <span class="keyword">new</span> StatusBarNotificationHolder(sbn);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				listener.onNotificationRemoved(sbnHolder, rankingUpdate);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">				Log.e(TAG, <span class="string">"unable to notify listener (removed): "</span> + listener, ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//系统服务类，NotificationManagerService的父类</span></span><br><span class="line">/android/frameworks/base/services/core/java/com/android/server/notification/ManagedServices.java 		</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">protected</span> IInterface <span class="title">asInterface</span><span class="params">(IBinder binder)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> ArrayList&lt;ManagedServiceInfo&gt; mServices = <span class="keyword">new</span> ArrayList&lt;ManagedServiceInfo&gt;();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">abstract</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ManagedServices</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">abstract</span> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onServiceAdded</span><span class="params">(ManagedServiceInfo info)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onServiceRemovedLocked</span><span class="params">(ManagedServiceInfo removed)</span> </span>&#123; &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//把Service对象从ManagedServices服务管理类对象中删除</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterService</span><span class="params">(IInterface service, <span class="keyword">int</span> userid)</span> </span>&#123;</span><br><span class="line">			checkNotNull(service);</span><br><span class="line">		unregisterServiceImpl(service, userid);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//把Service对象注册到ManagedServices服务管理类对象中</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerService</span><span class="params">(IInterface service, ComponentName component, <span class="keyword">int</span> userid)</span> </span>&#123;</span><br><span class="line">			checkNotNull(service);</span><br><span class="line">		ManagedServiceInfo info = registerServiceImpl(service, component, userid);</span><br><span class="line">		<span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</span><br><span class="line">			onServiceAdded(info);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> ManagedServiceInfo <span class="title">registerServiceImpl</span><span class="params">(<span class="keyword">final</span> IInterface service,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">final</span> ComponentName component, <span class="keyword">final</span> <span class="keyword">int</span> userid)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">synchronized</span> (mMutex) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				ManagedServiceInfo info = newServiceInfo(service, component, userid,</span><br><span class="line">						<span class="keyword">true</span> <span class="comment">/*isSystem*/</span>, <span class="keyword">null</span>, Build.VERSION_CODES.LOLLIPOP);</span><br><span class="line">				service.asBinder().linkToDeath(info, <span class="number">0</span>);</span><br><span class="line">				mServices.add(info);</span><br><span class="line">				<span class="keyword">return</span> info;</span><br><span class="line">			&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unregisterServiceImpl</span><span class="params">(IInterface service, <span class="keyword">int</span> userid)</span> </span>&#123;</span><br><span class="line">			ManagedServiceInfo info = removeServiceImpl(service, userid);</span><br><span class="line">		<span class="keyword">if</span> (info != <span class="keyword">null</span> &amp;&amp; info.connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">			mContext.unbindService(info.connection);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="SystemUI进程启动和绑定NotificationManagerService服务端过程："><a href="#SystemUI进程启动和绑定NotificationManagerService服务端过程：" class="headerlink" title="SystemUI进程启动和绑定NotificationManagerService服务端过程："></a>SystemUI进程启动和绑定NotificationManagerService服务端过程：</h1><p>至此，Notification框架的服务端就已经启动完毕，NotificationManagerService类只是管理Notification的逻辑，显示端是在SystemUI进程中实现的，那么NotificationManagerService服务对象和SystemUI进程间是怎么通信的呢？两个不同进程间通信，很多同学可能就会想到Android的远程过程调用（Remote Procedure Call，RPC）方式来实现，这种猜测是合理的，而且这里也的确是这么实现的。与很多其他的基于RPC的解决方案一样，Android使用一种接口定义语言（Interface Definition Language，IDL）来公开服务的接口。所以我们先来看下NotificationManagerService服务和SystemUI进程通信的服务接口文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">/android/frameworks/base/core/java/android/app/INotificationManager.aidl </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">INotificationManager</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cancelAllNotifications</span><span class="params">(String pkg, <span class="keyword">int</span> userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">enqueueToast</span><span class="params">(String pkg, ITransientNotification callback, <span class="keyword">int</span> duration)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cancelToast</span><span class="params">(String pkg, ITransientNotification callback)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">enqueueNotificationWithTag</span><span class="params">(String pkg, String opPkg, String tag, <span class="keyword">int</span> id,</span></span></span><br><span class="line"><span class="function"><span class="params">            in Notification notification, inout <span class="keyword">int</span>[] idReceived, <span class="keyword">int</span> userId)</span></span>;							<span class="comment">//发出通知的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cancelNotificationWithTag</span><span class="params">(String pkg, String tag, <span class="keyword">int</span> id, <span class="keyword">int</span> userId)</span></span>;							<span class="comment">//取消通知的方法</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setNotificationsEnabledForPackage</span><span class="params">(String pkg, <span class="keyword">int</span> uid, <span class="keyword">boolean</span> enabled)</span></span>;						<span class="comment">//Settings中关闭应用通知</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">areNotificationsEnabledForPackage</span><span class="params">(String pkg, <span class="keyword">int</span> uid)</span></span>;										<span class="comment">//判断应用是否可发通知</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setPackagePriority</span><span class="params">(String pkg, <span class="keyword">int</span> uid, <span class="keyword">int</span> priority)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPackagePriority</span><span class="params">(String pkg, <span class="keyword">int</span> uid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setPackagePeekable</span><span class="params">(String pkg, <span class="keyword">int</span> uid, <span class="keyword">boolean</span> peekable)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">getPackagePeekable</span><span class="params">(String pkg, <span class="keyword">int</span> uid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setPackageVisibilityOverride</span><span class="params">(String pkg, <span class="keyword">int</span> uid, <span class="keyword">int</span> visibility)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPackageVisibilityOverride</span><span class="params">(String pkg, <span class="keyword">int</span> uid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Remove this when callers have been migrated to the equivalent</span></span><br><span class="line">    <span class="comment">// INotificationListener method.</span></span><br><span class="line">    StatusBarNotification[] getActiveNotifications(String callingPkg);</span><br><span class="line">    StatusBarNotification[] getHistoricalNotifications(String callingPkg, <span class="keyword">int</span> count);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//注册INotificationListener服务的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerListener</span><span class="params">(in INotificationListener listener, in ComponentName component, <span class="keyword">int</span> userid)</span></span>;	</span><br><span class="line">	<span class="comment">//解除INotificationListener服务的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unregisterListener</span><span class="params">(in INotificationListener listener, <span class="keyword">int</span> userid)</span></span>;								</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cancelNotificationFromListener</span><span class="params">(in INotificationListener token, String pkg, String tag, <span class="keyword">int</span> id)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cancelNotificationsFromListener</span><span class="params">(in INotificationListener token, in String[] keys)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setNotificationsShownFromListener</span><span class="params">(in INotificationListener token, in String[] keys)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">ParceledListSlice <span class="title">getActiveNotificationsFromListener</span><span class="params">(in INotificationListener token, in String[] keys, <span class="keyword">int</span> trim)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">requestHintsFromListener</span><span class="params">(in INotificationListener token, <span class="keyword">int</span> hints)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getHintsFromListener</span><span class="params">(in INotificationListener token)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">requestInterruptionFilterFromListener</span><span class="params">(in INotificationListener token, <span class="keyword">int</span> interruptionFilter)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getInterruptionFilterFromListener</span><span class="params">(in INotificationListener token)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setOnNotificationPostedTrimFromListener</span><span class="params">(in INotificationListener token, <span class="keyword">int</span> trim)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setInterruptionFilter</span><span class="params">(String pkg, <span class="keyword">int</span> interruptionFilter)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">ComponentName <span class="title">getEffectsSuppressor</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">matchesCallFilter</span><span class="params">(in Bundle extras)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">matchesMessageFilter</span><span class="params">(in Bundle extras)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isSystemConditionProviderEnabled</span><span class="params">(String path)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getZenMode</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">ZenModeConfig <span class="title">getZenModeConfig</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">setZenModeConfig</span><span class="params">(in ZenModeConfig config, String reason)</span></span>;</span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">setZenMode</span><span class="params">(<span class="keyword">int</span> mode, in Uri conditionId, String reason)</span></span>;</span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">notifyConditions</span><span class="params">(String pkg, in IConditionProvider provider, in Condition[] conditions)</span></span>;</span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">requestZenModeConditions</span><span class="params">(in IConditionListener callback, <span class="keyword">int</span> relevance)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isNotificationPolicyAccessGranted</span><span class="params">(String pkg)</span></span>;</span><br><span class="line">    NotificationManager.<span class="function">Policy <span class="title">getNotificationPolicy</span><span class="params">(String pkg)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setNotificationPolicy</span><span class="params">(String pkg, in NotificationManager.Policy policy)</span></span>;</span><br><span class="line">    String[] getPackagesRequestingNotificationPolicyAccess();</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isNotificationPolicyAccessGrantedForPackage</span><span class="params">(String pkg)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setNotificationPolicyAccessGranted</span><span class="params">(String pkg, <span class="keyword">boolean</span> granted)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span>[] getBackupPayload(<span class="keyword">int</span> user);</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">applyRestore</span><span class="params">(in <span class="keyword">byte</span>[] payload, <span class="keyword">int</span> user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">ParceledListSlice <span class="title">getAppActiveNotifications</span><span class="params">(String callingPkg, <span class="keyword">int</span> userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//***************************************************************//</span></span><br><span class="line">    <span class="comment">// ++ @noti.sysui [START] NotificationManager APIs for SEC ONLY  //</span></span><br><span class="line">    <span class="comment">//***************************************************************//</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isNotificationInterruptable</span><span class="params">(String pkg, String opPkg, String tag, <span class="keyword">int</span> id, </span></span></span><br><span class="line"><span class="function"><span class="params">                in Notification notification, in <span class="keyword">long</span> time, <span class="keyword">int</span> userId)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cancelSummaryNotificationWithTag</span><span class="params">(String pkg, String tag, <span class="keyword">int</span> id, <span class="keyword">int</span> userId)</span></span>;</span><br><span class="line">    <span class="comment">//***************************************************************///</span></span><br><span class="line">    <span class="comment">// -- @noti.sysui [START] NotificationManager APIs for SEC ONLY  //</span></span><br><span class="line">    <span class="comment">//***************************************************************//</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment">//WTL_EDM_START</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clearAllNotificationsAsUser</span><span class="params">(<span class="keyword">int</span> userId)</span></span>;</span><br><span class="line">    <span class="comment">//WTL_EDM_END</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">enqueueEdgeNotification</span><span class="params">(String pkg, String opPkg, <span class="keyword">int</span> id, in Bundle extras, <span class="keyword">int</span> userId)</span></span>;	<span class="comment">//发侧屏通知的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">removeEdgeNotification</span><span class="params">(String pkg, <span class="keyword">int</span> id, in Bundle extras, <span class="keyword">int</span> userId)</span></span>;					<span class="comment">//删除侧屏通知的方法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/android/frameworks/base/core/java/android/service/notification/INotificationListener.aidl </span><br><span class="line"></span><br><span class="line">oneway <span class="class"><span class="keyword">interface</span> <span class="title">INotificationListener</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onListenerConnected</span><span class="params">(in NotificationRankingUpdate update)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onNotificationPosted</span><span class="params">(in IStatusBarNotificationHolder notificationHolder,</span></span></span><br><span class="line"><span class="function"><span class="params">            in NotificationRankingUpdate update)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onNotificationRemoved</span><span class="params">(in IStatusBarNotificationHolder notificationHolder,</span></span></span><br><span class="line"><span class="function"><span class="params">            in NotificationRankingUpdate update)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onNotificationRankingUpdate</span><span class="params">(in NotificationRankingUpdate update)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onListenerHintsChanged</span><span class="params">(<span class="keyword">int</span> hints)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onInterruptionFilterChanged</span><span class="params">(<span class="keyword">int</span> interruptionFilter)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onEdgeNotificationPosted</span><span class="params">(String pkg, <span class="keyword">int</span> id, in Bundle extra)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onEdgeNotificationRemoved</span><span class="params">(String pkg, <span class="keyword">int</span> id, in Bundle extra)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个接口类的服务端就是NotificationManagerService服务对象中的INotificationManager.Stub对象mService</p>
<pre><code>private final IBinder mService = new INotificationManager.Stub(){};
</code></pre><p>客户端可以通过以下方式来获取和服务端通信的桩对象：</p>
<pre><code>IBinder b = ServiceManager.getService(Context.NOTIFICATION_SERVICE);
INotificationManager service = INotificationManager.Stub.asInterface(b);
</code></pre><p>SystemUI进程在初始化过程中，会创建一个NotificationListenerService服务类，服务对象中创建一个INotificationListener对象并通过远程过程调用把这个INotificationListener对象注册到NotificationManagerService服务对象的服务管理类子类NotificationListeners对象mListeners中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">/android/frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/BaseStatusBar.java </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> NotificationListenerService mNotificationListener =</span><br><span class="line">        <span class="keyword">new</span> NotificationListenerService() &#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNotificationPosted</span><span class="params">(<span class="keyword">final</span> StatusBarNotification sbn,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> RankingMap rankingMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"onNotificationPosted: "</span> + sbn);</span><br><span class="line">        <span class="keyword">if</span> (sbn != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    String key = sbn.getKey();</span><br><span class="line">                    <span class="keyword">boolean</span> isUpdate = mNotificationData.get(key) != <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (isUpdate) &#123;</span><br><span class="line">                        updateNotification(sbn, rankingMap);					<span class="comment">//更新Notification</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        addNotification(sbn, rankingMap, <span class="keyword">null</span> <span class="comment">/* oldEntry */</span>);	<span class="comment">//添加Notification</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNotificationRemoved</span><span class="params">(StatusBarNotification sbn,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> RankingMap rankingMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"onNotificationRemoved: "</span> + sbn);</span><br><span class="line">        <span class="keyword">if</span> (sbn != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> String key = sbn.getKey();</span><br><span class="line">            mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    removeNotification(key, rankingMap);						<span class="comment">//删除Notification</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    mNotificationListener.registerAsSystemService(mContext,</span><br><span class="line">            <span class="keyword">new</span> ComponentName(mContext.getPackageName(), getClass().getCanonicalName()),</span><br><span class="line">            UserHandle.USER_ALL);	<span class="comment">//把NotificationListenerService对象注册为系统服务并通过和NotificationManagerService服务远程通信</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/android/frameworks/base/core/java/android/service/notification/NotificationListenerService.java </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAsSystemService</span><span class="params">(Context context, ComponentName componentName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> currentUser)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    mSystemContext = context;</span><br><span class="line">    <span class="keyword">if</span> (mWrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWrapper = <span class="keyword">new</span> INotificationListenerWrapper();</span><br><span class="line">    &#125;</span><br><span class="line">    INotificationManager noMan = getNotificationInterface();</span><br><span class="line">	<span class="comment">//通过远程过程把INotificationListener注册到NotificationManagerService服务对象中，</span></span><br><span class="line">	<span class="comment">//这样NotificationManagerService对象就可以通过INotificationListener通信对象</span></span><br><span class="line">	<span class="comment">//直接回调SystemUI进程中的NotificationListenerService对象来操作显示UI</span></span><br><span class="line">    noMan.registerListener(mWrapper, componentName, currentUser);</span><br><span class="line">    mCurrentUser = currentUser;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> INotificationManager <span class="title">getNotificationInterface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mNoMan == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mNoMan = INotificationManager.Stub.asInterface(</span><br><span class="line">                ServiceManager.getService(Context.NOTIFICATION_SERVICE));	<span class="comment">//这里就是上面客户端可以获取和服务端通信的桩对象的过程</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mNoMan;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNotificationPosted</span><span class="params">(StatusBarNotification sbn)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// optional		//在SystemUI中BaseStatusBar的NotificationListenerService重写了这个方法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">INotificationListenerWrapper</span> <span class="keyword">extends</span> <span class="title">INotificationListener</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNotificationPosted</span><span class="params">(IStatusBarNotificationHolder sbnHolder,</span></span></span><br><span class="line"><span class="function"><span class="params">            NotificationRankingUpdate update)</span> </span>&#123;</span><br><span class="line">        StatusBarNotification sbn;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sbn = sbnHolder.get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (mWrapper) &#123;</span><br><span class="line">            applyUpdate(update);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (sbn != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    NotificationListenerService.<span class="keyword">this</span>.onNotificationPosted(sbn, mRankingMap);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    NotificationListenerService.<span class="keyword">this</span>.onNotificationRankingUpdate(mRankingMap);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"Error running onNotificationPosted"</span>, t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNotificationRemoved</span><span class="params">(IStatusBarNotificationHolder sbnHolder,NotificationRankingUpdate update)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onListenerConnected</span><span class="params">(NotificationRankingUpdate update)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNotificationRankingUpdate</span><span class="params">(NotificationRankingUpdate update)</span> <span class="keyword">throws</span> RemoteException </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onListenerHintsChanged</span><span class="params">(<span class="keyword">int</span> hints)</span> <span class="keyword">throws</span> RemoteException </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInterruptionFilterChanged</span><span class="params">(<span class="keyword">int</span> interruptionFilter)</span> <span class="keyword">throws</span> RemoteException </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEdgeNotificationPosted</span><span class="params">(String pkg, <span class="keyword">int</span> id, Bundle extra)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEdgeNotificationRemoved</span><span class="params">(String pkg, <span class="keyword">int</span> id, Bundle extra)</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Notification调用过程"><a href="#Notification调用过程" class="headerlink" title="Notification调用过程"></a>Notification调用过程</h1><p>Notification调用过程可以从应用开始，通过NotificationManager.notify()来发出通知，NotificationManager通过和NotificationManagerService服务对象通信，NotificationManagerService服务对象再利用通过NotificationListeners中监听的服务列表与SystemUI进程启动的系统服务NotificationListenerService中的INotificationListener对象通信，就可以调用SystemUI进程进行显示。</p>
<h3 id="调用过程如下图所示："><a href="#调用过程如下图所示：" class="headerlink" title="调用过程如下图所示："></a>调用过程如下图所示：</h3><img src="/2017/03/19/Notification框架简介/时序图.jpg" title="时序图">
<h3 id="对应的代码，如以下所示："><a href="#对应的代码，如以下所示：" class="headerlink" title="对应的代码，如以下所示："></a>对应的代码，如以下所示：</h3><p>应用程序要发通知或取消通知，只需要获取系统的通知管理服务，调用notify或者cancel来操作通知即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NotificationManager nm = (NotificationManager)getSystemService(Context.NOTIFICATION_SERVICE);	<span class="comment">//获取通知管理服务</span></span><br><span class="line">Notification.Builder builder = <span class="keyword">new</span> Notification.Builder(<span class="keyword">this</span>);</span><br><span class="line">builder.setSmallIcon(R.drawable.smallicon)</span><br><span class="line">		.setContentTitle(<span class="string">"This is Title"</span>)</span><br><span class="line">		.setContentText(<span class="string">"This is Content"</span>);</span><br><span class="line">Notification n = b.build();																		<span class="comment">//创建Notification</span></span><br><span class="line">nm.notify(ID, n);																				<span class="comment">//发通知</span></span><br></pre></td></tr></table></figure>
<p>NotificationManager是管理通知的服务类，它负责与NotificationManagerService服务对象通信，并通过调用NotificationManagerService服务对象添加、更新、删除通知等等，所支持的功能可以参照远程通信服务接口INotificationManager.aidl中公开的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/android/frameworks/base/core/java/android/app/NotificationManager.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> INotificationManager sService;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> INotificationManager <span class="title">getService</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sService != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> sService;</span><br><span class="line">    &#125;</span><br><span class="line">    IBinder b = ServiceManager.getService(<span class="string">"notification"</span>);	<span class="comment">//获取系统服务的桩对象</span></span><br><span class="line">    sService = INotificationManager.Stub.asInterface(b);	<span class="comment">//把桩对象转化成远程通信对象</span></span><br><span class="line">    <span class="keyword">return</span> sService;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(<span class="keyword">int</span> id, Notification notification)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    notify(<span class="keyword">null</span>, id, notification);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(String tag, <span class="keyword">int</span> id, Notification notification)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] idOut = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">    INotificationManager service = getService();</span><br><span class="line">    String pkg = mContext.getPackageName();</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    Notification stripped = notification.clone();</span><br><span class="line">    Builder.stripForDelivery(stripped);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//调用远程服务对象的enqueueNotificationWithTag()方法来调用NotificationManagerService对象发出通知</span></span><br><span class="line">        service.enqueueNotificationWithTag(pkg, mContext.getOpPackageName(), tag, id,</span><br><span class="line">                stripped, idOut, UserHandle.myUserId());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NotificationManagerService服务对象只是处理逻辑，显示的逻辑是放在系统UI的进程SystemUI中去的，所以NotificationManagerService服务对象处理完逻辑后，还需要远程调用SystemUI进程去更新显示。所以SystemUI进程需要把INotificationListener服务对象注册到NotificationManagerService服务对象中来，当需要更新UI是，就可以通过INotificationListener服务对象回调SystemUI进程中的方法来更新。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">/android/frameworks/base/services/core/java/com/android/server/notification/NotificationManagerService.java </span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">mListeners = <span class="keyword">new</span> NotificationListeners();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> IBinder mService = <span class="keyword">new</span> INotificationManager.Stub() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueueNotificationWithTag</span><span class="params">(String pkg, String opPkg, String tag, <span class="keyword">int</span> id,</span></span></span><br><span class="line"><span class="function"><span class="params">        Notification notification, <span class="keyword">int</span>[] idOut, <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    enqueueNotificationInternal(pkg, opPkg, Binder.getCallingUid(),</span><br><span class="line">            Binder.getCallingPid(), tag, id, notification, idOut, userId);	<span class="comment">//添加或更新Notification</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enqueueNotificationInternal</span><span class="params">(<span class="keyword">final</span> String pkg, <span class="keyword">final</span> String opPkg, <span class="keyword">final</span> <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> <span class="keyword">int</span> callingPid, <span class="keyword">final</span> String tag, <span class="keyword">final</span> <span class="keyword">int</span> id, <span class="keyword">final</span> Notification notification,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span>[] idOut, <span class="keyword">int</span> incomingUserId)</span> </span>&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mNotificationList) &#123;</span><br><span class="line">			<span class="comment">//...</span></span><br><span class="line">			<span class="comment">//调用服务管理对象mListeners来更新所有注册到mListeners中的NotificationListenerService对象</span></span><br><span class="line">			mListeners.notifyPostedLocked(n, oldSbn);</span><br><span class="line">			<span class="comment">//实现播放notification的铃声，使led灯亮起来或者震动等操作。buzz:嗡嗡叫，beep: 嘟嘟响，blink: 闪烁</span></span><br><span class="line">            buzzBeepBlinkLocked(r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">idOut[<span class="number">0</span>] = id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotificationListeners</span> <span class="keyword">extends</span> <span class="title">ManagedServices</span> </span>&#123;	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyPostedLocked</span><span class="params">(StatusBarNotification sbn, StatusBarNotification oldSbn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> ManagedServiceInfo info : mServices) &#123;</span><br><span class="line">        mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                notifyPosted(info, sbnToPost, update);	<span class="comment">//调用更新通知方法</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyPosted</span><span class="params">(<span class="keyword">final</span> ManagedServiceInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> StatusBarNotification sbn, NotificationRankingUpdate rankingUpdate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> INotificationListener listener = (INotificationListener)info.service;</span><br><span class="line">    StatusBarNotificationHolder sbnHolder = <span class="keyword">new</span> StatusBarNotificationHolder(sbn);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//回调NotificationListenerService对象中的方法onNotificationPosted()，在SystemUI中显示Notification</span></span><br><span class="line">        listener.onNotificationPosted(sbnHolder, rankingUpdate);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"unable to notify listener (posted): "</span> + listener, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>INotificationListener服务对象是从BaseStatusBar对象中启动的系统服务BNotificationListenerService注册到NotificationManagerService对象中的，当NotificationManagerService服务对象通过INotificationListener服务对象回调SystemUI进程中的方法时，就可以调用BaseStatusBar对象中的方法来更新UI显示了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">/android/frameworks/base/core/java/android/service/notification/NotificationListenerService.java 	</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">INotificationListenerWrapper</span> <span class="keyword">extends</span> <span class="title">INotificationListener</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNotificationPosted</span><span class="params">(IStatusBarNotificationHolder sbnHolder,</span></span></span><br><span class="line"><span class="function"><span class="params">            NotificationRankingUpdate update)</span> </span>&#123;</span><br><span class="line">        StatusBarNotification sbn;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sbn = sbnHolder.get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (mWrapper) &#123;</span><br><span class="line">            applyUpdate(update);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (sbn != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    NotificationListenerService.<span class="keyword">this</span>.onNotificationPosted(sbn, mRankingMap);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    NotificationListenerService.<span class="keyword">this</span>.onNotificationRankingUpdate(mRankingMap);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"Error running onNotificationPosted"</span>, t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/android/frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/BaseStatusBar.java </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> NotificationListenerService mNotificationListener =</span><br><span class="line">        <span class="keyword">new</span> NotificationListenerService() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNotificationPosted</span><span class="params">(<span class="keyword">final</span> StatusBarNotification sbn,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> RankingMap rankingMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sbn != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    String key = sbn.getKey();</span><br><span class="line">                    <span class="keyword">boolean</span> isUpdate = mNotificationData.get(key) != <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (isUpdate) &#123;</span><br><span class="line">                        updateNotification(sbn, rankingMap);					<span class="comment">//更新Notification,</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        addNotification(sbn, rankingMap, <span class="keyword">null</span> <span class="comment">/* oldEntry */</span>);	<span class="comment">//添加Notification</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>PhoneStatusBar是BaseStatusBar的子类，实现了BaseStatusBar中的相关方法，addNotification()就是其中之一，这个方法是用来添加Notification和状态栏通知图标的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line">/android/frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBar.java </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addNotification</span><span class="params">(StatusBarNotification notification, RankingMap ranking,</span></span></span><br><span class="line"><span class="function"><span class="params">        Entry oldEntry)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    Entry shadeEntry = createNotificationViews(notification);	<span class="comment">//创建状态栏通知图标和通知列表行布局</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="comment">//把创建的状态栏通知图标和通知列表行布局分别添加到状态栏通知栏和通知列表NotificatioStackScrollLayout中</span></span><br><span class="line">    addNotificationViews(shadeEntry, ranking);</span><br><span class="line">    setAreThereNotifications();</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> NotificationData.<span class="function">Entry <span class="title">createNotificationViews</span><span class="params">(StatusBarNotification sbn)</span> </span>&#123;	<span class="comment">//创建状态栏通知图标和通知列表行布局</span></span><br><span class="line">    <span class="keyword">final</span> StatusBarIconView iconView = createIcon(sbn);			<span class="comment">//创建状态栏通知图标</span></span><br><span class="line">    <span class="keyword">if</span> (iconView == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    NotificationData.Entry entry = <span class="keyword">new</span> NotificationData.Entry(sbn, iconView);</span><br><span class="line">    <span class="keyword">if</span> (!inflateViews(entry, mStackScroller)) &#123;					<span class="comment">//创建展开通知布局列表中的通知一行的布局</span></span><br><span class="line">        handleNotificationError(sbn, <span class="string">"Couldn't expand RemoteViews for: "</span> + sbn);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> entry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> StatusBarIconView <span class="title">createIcon</span><span class="params">(StatusBarNotification sbn)</span> </span>&#123;					<span class="comment">//创建状态栏通知图标</span></span><br><span class="line">    Notification n = sbn.getNotification();</span><br><span class="line">    <span class="keyword">final</span> StatusBarIconView iconView = <span class="keyword">new</span> StatusBarIconView(mContext,</span><br><span class="line">            sbn.getPackageName() + <span class="string">"/0x"</span> + Integer.toHexString(sbn.getId()), n);	<span class="comment">//创建状态栏通知图标布局View</span></span><br><span class="line">    iconView.setScaleType(ImageView.ScaleType.CENTER_INSIDE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Icon smallIcon = n.getSmallIcon();</span><br><span class="line">    <span class="keyword">if</span> (smallIcon == <span class="keyword">null</span>) &#123;</span><br><span class="line">        handleNotificationError(sbn,</span><br><span class="line">                <span class="string">"No small icon in notification from "</span> + sbn.getPackageName());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> StatusBarIcon ic = <span class="keyword">new</span> StatusBarIcon(</span><br><span class="line">            sbn.getUser(),</span><br><span class="line">            sbn.getPackageName(),</span><br><span class="line">            smallIcon,</span><br><span class="line">            n.iconLevel,</span><br><span class="line">            n.number,</span><br><span class="line">            n.tickerText);</span><br><span class="line">    <span class="keyword">if</span> (!iconView.set(ic)) &#123;									<span class="comment">//把StatusBarIcon传到状态栏通知图标布局View中</span></span><br><span class="line">        handleNotificationError(sbn, <span class="string">"Couldn't create icon: "</span> + ic);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> iconView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">inflateViews</span><span class="params">(Entry entry, ViewGroup parent)</span> </span>&#123;	<span class="comment">//创建展开通知布局列表中的通知一行的布局</span></span><br><span class="line">    <span class="keyword">final</span> StatusBarNotification sbn = entry.notification;</span><br><span class="line"></span><br><span class="line">    RemoteViews contentView = sbn.getNotification().contentView;			  <span class="comment">//通知布局的contentView布局</span></span><br><span class="line">    RemoteViews bigContentView = sbn.getNotification().bigContentView;		  <span class="comment">//通知布局的bigContentView布局</span></span><br><span class="line">    RemoteViews headsUpContentView = sbn.getNotification().headsUpContentView;<span class="comment">//通知布局的headsUpContentView布局</span></span><br><span class="line"></span><br><span class="line">    Notification publicNotification = sbn.getNotification().publicVersion;</span><br><span class="line"></span><br><span class="line">    ExpandableNotificationRow row;								<span class="comment">//创建通知布局列表中的一行的布局</span></span><br><span class="line">    <span class="keyword">if</span> (entry.row != <span class="keyword">null</span>) &#123;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LayoutInflater inflater = (LayoutInflater) mContext.getSystemService(</span><br><span class="line">                Context.LAYOUT_INFLATER_SERVICE);</span><br><span class="line">        row = (ExpandableNotificationRow) inflater.inflate(R.layout.status_bar_notification_row,</span><br><span class="line">                parent, <span class="keyword">false</span>);</span><br><span class="line">        row.setExpansionLogger(<span class="keyword">this</span>, entry.notification.getKey());</span><br><span class="line">        row.setGroupManager(mGroupManager);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    NotificationContentView contentContainer = row.getPrivateLayout();</span><br><span class="line">    NotificationContentView contentContainerPublic = row.getPublicLayout();</span><br><span class="line">    NotificationContentView expandedKnox = row.getKnoxLayout();</span><br><span class="line"></span><br><span class="line">    mNotificationClicker.register(row, sbn);</span><br><span class="line"></span><br><span class="line">    View contentViewLocal = <span class="keyword">null</span>;</span><br><span class="line">    View bigContentViewLocal = <span class="keyword">null</span>;</span><br><span class="line">    View headsUpContentViewLocal = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        contentViewLocal = contentView.apply(</span><br><span class="line">                sbn.getPackageContext(mContext),</span><br><span class="line">                contentContainer,</span><br><span class="line">                mOnClickHandler);								<span class="comment">//把contentView添加到通知布局列表中通知行容器中</span></span><br><span class="line">        <span class="keyword">if</span> (bigContentView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            bigContentViewLocal = bigContentView.apply(</span><br><span class="line">                    sbn.getPackageContext(mContext),</span><br><span class="line">                    contentContainer,</span><br><span class="line">                    mOnClickHandler);							<span class="comment">//把bigContentView添加到通知布局列表中通知行容器中</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (headsUpContentView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            headsUpContentViewLocal = headsUpContentView.apply(</span><br><span class="line">                    sbn.getPackageContext(mContext),</span><br><span class="line">                    contentContainer,</span><br><span class="line">                    mOnClickHandler);							<span class="comment">//把headsUpContentView添加到通知布局列表中通知行容器中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    View publicViewLocal = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (publicNotification != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            publicViewLocal = publicNotification.contentView.apply(</span><br><span class="line">                    sbn.getPackageContext(mContext),</span><br><span class="line">                    contentContainerPublic, mOnClickHandler);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            publicViewLocal = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//把创建的状态栏通知图标和通知列表行布局分别添加到状态栏通知栏和通知列表NotificatioStackScrollLayout中</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addNotificationViews</span><span class="params">(Entry entry, RankingMap ranking)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mNotificationData.add(entry, ranking);	<span class="comment">//先把通知添加到NotificationData中去</span></span><br><span class="line">    updateNotifications();<span class="comment">//根据更新后的NotificationData数据更新状态栏通知图标和通知列表NotificationStackScrollLayout布局</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">updateNotifications</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mNotificationData.filterAndSort();		<span class="comment">//过滤和排序通知的顺序</span></span><br><span class="line"></span><br><span class="line">    updateNotificationShade();				<span class="comment">//添加或者更新NotificationStackScrollLayout中的Notification</span></span><br><span class="line">    mIconController.updateNotificationIcons(mNotificationData);	<span class="comment">//添加或者更新状态栏左上角通知栏图标</span></span><br><span class="line"></span><br><span class="line">    mNotificationPanel.updateCarrierAndClearLayout();			<span class="comment">//更新通信类型和清除布局</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateNotificationShade</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;Entry&gt; activeNotifications = mNotificationData.getActiveNotifications();</span><br><span class="line">    ArrayList&lt;ExpandableNotificationRow&gt; toShow = <span class="keyword">new</span> ArrayList&lt;&gt;(activeNotifications.size());</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//把所有需要显示的Notification添加到toShow列表中</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">int</span> N = activeNotifications.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        Entry ent = activeNotifications.get(i);</span><br><span class="line">        toShow.add(ent.row);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//通过判断mStackScroller中各个child是否在toShow列表；不在的话，就添加toRemove列表中，待会一起删除</span></span><br><span class="line">    ArrayList&lt;View&gt; toRemove = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt; mStackScroller.getChildCount(); i++) &#123;</span><br><span class="line">        View child = mStackScroller.getChildAt(i);</span><br><span class="line">        <span class="keyword">if</span> (!toShow.contains(child) &amp;&amp; child <span class="keyword">instanceof</span> ExpandableNotificationRow) &#123;<span class="comment">//child是否在toShow列表</span></span><br><span class="line">            toRemove.add(child);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//把toRemove列表中需要删除的child，都删除掉</span></span><br><span class="line">    <span class="keyword">for</span> (View remove : toRemove) &#123;</span><br><span class="line">        mStackScroller.removeView(remove);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//判断toShow列表中，有哪些是新添加的通知(可以通过通知View是否有父容器来判断)，新的通知就添加到mStackScroller中</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;toShow.size(); i++) &#123;</span><br><span class="line">        View v = toShow.get(i);</span><br><span class="line">        <span class="keyword">if</span> (v.getParent() == <span class="keyword">null</span>) &#123;	<span class="comment">//这里通过通知View是否有父容器来判断这条通知是否是新的</span></span><br><span class="line">            mStackScroller.addView(v);	<span class="comment">//新通知就添加到mStackScroller中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//以上已经把需要显示或者删除的通知都处理完了，但是还需要重新调整顺序</span></span><br><span class="line">	<span class="comment">//从mStackScroller中顺序判断每个child的顺序是否与toShow列表中的顺序一样</span></span><br><span class="line">	<span class="comment">//不一样的，就把顺序调整下</span></span><br><span class="line">    <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mStackScroller.getChildCount(); i++) &#123;</span><br><span class="line">        View child = mStackScroller.getChildAt(i);</span><br><span class="line">        ExpandableNotificationRow targetChild = toShow.get(j);</span><br><span class="line">        <span class="keyword">if</span> (child != targetChild) &#123;		<span class="comment">//顺序不对</span></span><br><span class="line">            mStackScroller.changeViewPosition(targetChild, i);	<span class="comment">//调整顺序</span></span><br><span class="line">        &#125;</span><br><span class="line">        j++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    updateNotificationShadeForChildren();	<span class="comment">//更新每个Group Notification中的child Notification</span></span><br><span class="line">    updateRowStates();						<span class="comment">//更新Notification布局中的Item展开情况、dim情况和锁屏状态下的通知布局情况，很重要的一个方法</span></span><br><span class="line">    updateClearAll();						<span class="comment">//更新清楚所有按钮布局</span></span><br><span class="line">    updateEmptyShadeView();					<span class="comment">//隐藏"No Notification"</span></span><br><span class="line">    updateQsExpansionEnabled();				<span class="comment">//关闭QS功能</span></span><br><span class="line">    mShadeUpdates.check();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/android/frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/NotificationData.java </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">filterAndSort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mSortedAndFiltered.clear();			<span class="comment">//清除mSortedAndFiltered列表</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = mEntries.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        Entry entry = mEntries.valueAt(i);</span><br><span class="line">        StatusBarNotification sbn = entry.notification;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shouldFilterOut(sbn)) &#123;		<span class="comment">//判断是否需要过滤掉</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mSortedAndFiltered.add(entry);	<span class="comment">//添加到mSortedAndFiltered列表中</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Collections.sort(mSortedAndFiltered, mRankingComparator);	<span class="comment">//重新排序mSortedAndFiltered中的选项</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StatusBarIconController是状态栏图标控制的类，用来控制状态栏通知图标显示和系统图标显示等等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">/android/frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/phone/StatusBarIconController.java </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> IconMerger mNotificationIcons;		<span class="comment">//状态栏通知图标容器对象</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StatusBarIconController</span><span class="params">(Context context, View statusBar, View keyguardStatusBar,</span></span></span><br><span class="line"><span class="function"><span class="params">        PhoneStatusBar phoneStatusBar)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    mNotificationIcons = (IconMerger) statusBar.findViewById(R.id.notificationIcons);	<span class="comment">//获取状态栏图标的容器类</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateNotificationIcons</span><span class="params">(NotificationData notificationData)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> iconSize = mContext.getResources().getDimensionPixelSize(R.dimen.notification_icon_view_width);	<span class="comment">//图标宽度</span></span><br><span class="line">    <span class="keyword">final</span> LinearLayout.LayoutParams params = <span class="keyword">new</span> LinearLayout.LayoutParams(</span><br><span class="line">            iconSize + <span class="number">2</span>*mIconHPadding, mPhoneStatusBar.getStatusBarHeight());	<span class="comment">//状态栏图标的布局参数(宽度x高度)</span></span><br><span class="line"></span><br><span class="line">    ArrayList&lt;NotificationData.Entry&gt; activeNotifications =</span><br><span class="line">            notificationData.getActiveNotifications();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = activeNotifications.size();</span><br><span class="line">    ArrayList&lt;StatusBarIconView&gt; toShow = <span class="keyword">new</span> ArrayList&lt;&gt;(N);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//把所有需要显示的Notification添加到toShow列表中</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        NotificationData.Entry ent = activeNotifications.get(i);</span><br><span class="line">		<span class="comment">//过滤环境通知，例如：插USB或者充电线时的通知，是不需要显示状态栏中的图标的</span></span><br><span class="line">        <span class="keyword">if</span> (notificationData.isAmbient(ent.key)</span><br><span class="line">                &amp;&amp; !NotificationData.showNotificationEvenIfUnprovisioned(ent.notification)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!PhoneStatusBar.isTopLevelChild(ent)) &#123;							<span class="comment">//过滤分组的组图标</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((ent.notification.getNotification().secFlags</span><br><span class="line">                &amp; Notification.SEC_FLAG_HIDE_NOTIFICATION_ICON) !=<span class="number">0</span>) &#123;		<span class="comment">//过滤掉设置了隐藏状态栏图标的通知</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!mPhoneStatusBar.shouldShowOnIndicator(ent.notification.getKey())) &#123;	<span class="comment">//过滤设置了隐藏图标的包的通知</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        toShow.add(ent.icon);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//通过判断mNotificationIcons中各个child是否在toShow列表；不在的话，就添加toRemove列表中，待会一起删除</span></span><br><span class="line">    ArrayList&lt;View&gt; toRemove = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mNotificationIcons.getChildCount(); i++) &#123;</span><br><span class="line">        View child = mNotificationIcons.getChildAt(i);</span><br><span class="line">        <span class="keyword">if</span> (!toShow.contains(child)) &#123;										<span class="comment">//child是否在toShow列表</span></span><br><span class="line">            toRemove.add(child);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//把toRemove列表中需要删除的child，都删除掉</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> toRemoveCount = toRemove.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; toRemoveCount; i++) &#123;</span><br><span class="line">        mNotificationIcons.removeView(toRemove.get(i));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//判断toShow列表中，有哪些是新添加的通知(可以通过通知View是否有父容器来判断)，新的通知就添加到mNotificationIcons中</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;toShow.size(); i++) &#123;</span><br><span class="line">        View v = toShow.get(i);</span><br><span class="line">        <span class="keyword">if</span> (v.getParent() == <span class="keyword">null</span>) &#123;							<span class="comment">//这里通过通知View是否有父容器来判断这条通知是否是新的</span></span><br><span class="line">            mNotificationIcons.addView(v, i, params);			<span class="comment">//新通知就添加到mStackScroller中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//以上已经把需要显示或者删除的通知都处理完了，但是还需要重新调整顺序</span></span><br><span class="line">	<span class="comment">//从mNotificationIcons中顺序判断每个child的顺序是否与toShow列表中的顺序一样</span></span><br><span class="line">	<span class="comment">//不一样的，就把顺序调整下</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = mNotificationIcons.getChildCount();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        View actual = mNotificationIcons.getChildAt(i);</span><br><span class="line">        StatusBarIconView expected = toShow.get(i);</span><br><span class="line">        <span class="keyword">if</span> (actual == expected) &#123;	<span class="comment">//顺序正确的就不处理</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mNotificationIcons.removeView(expected);	<span class="comment">//把顺序错误的View先删除</span></span><br><span class="line">        mNotificationIcons.addView(expected, i);	<span class="comment">//再添加到正确的顺序位置上</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    applyNotificationIconsTint();					<span class="comment">//更新状态栏图标的颜色</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/android/frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/phone/IconMerger.java </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IconMerger</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span></span>&#123;		<span class="comment">//状态栏通知图标容器类</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把状态栏通知图标和通知行布局都分别添加到相应的容器类后，显示部分的逻辑也就完成了。</p>
<h1 id="Notification通知提示音响起过程"><a href="#Notification通知提示音响起过程" class="headerlink" title="Notification通知提示音响起过程"></a>Notification通知提示音响起过程</h1><p>SystemUI的RingtonePlayer服务通过IAudioService.setRingtonePlayer(IRingtonePlayer)把IRingtonePlayer实现的回调接口对象注册到AudioService服务中，第三方App调用NotificationManager.notify()时，会调用NotificationManagerService中的enqueueNotificationInternal方法中的buzzBeepBlinkLocked()方法，这个方法会通过IAudioService.getRingtonePlayer()获取AudioServoce中的IRingtonePlayer对象，并调用回调方法来调用SystenUI.RingtonePlayer.mCallback的playAsync()来实现播放notification铃声、震动、闪烁灯功能。</p>
<h3 id="调用过程如下图所示：-1"><a href="#调用过程如下图所示：-1" class="headerlink" title="调用过程如下图所示："></a>调用过程如下图所示：</h3><img src="/2017/03/19/Notification框架简介/时序图2.jpg" title="时序图2">
<h3 id="对应的代码，如以下所示：-1"><a href="#对应的代码，如以下所示：-1" class="headerlink" title="对应的代码，如以下所示："></a>对应的代码，如以下所示：</h3><p>启动AudioService服务过程，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/android/frameworks/base/services/java/com/android/server/SystemServer.java </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	AudioService audioService = <span class="keyword">null</span>;</span><br><span class="line">	audioService = <span class="keyword">new</span> AudioService(context);</span><br><span class="line">	ServiceManager.addService(Context.AUDIO_SERVICE, audioService);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/android/frameworks/base/services/core/java/com/android/server/audio/AudioService.java </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AudioService</span> <span class="keyword">extends</span> <span class="title">IAudioService</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> IRingtonePlayer mRingtonePlayer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRingtonePlayer</span><span class="params">(IRingtonePlayer player)</span> </span>&#123;</span><br><span class="line">        mContext.enforceCallingOrSelfPermission(REMOTE_AUDIO_PLAYBACK, <span class="keyword">null</span>);</span><br><span class="line">        mRingtonePlayer = player;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IRingtonePlayer <span class="title">getRingtonePlayer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mRingtonePlayer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动SystemUI的RingtonePlayer服务过程，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">/android/frameworks/base/packages/SystemUI/src/com/android/systemui/SystemUIApplication.java </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt;[] SERVICES = <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        com.android.systemui.tuner.TunerService.class,</span><br><span class="line">        com.android.systemui.keyguard.KeyguardViewMediator.class,</span><br><span class="line">        com.android.systemui.recents.Recents.class,</span><br><span class="line">        com.android.systemui.volume.VolumeUI.class,</span><br><span class="line">        com.android.systemui.statusbar.SystemBars.class,</span><br><span class="line">        com.android.systemui.usb.StorageNotification.class,</span><br><span class="line">        com.android.systemui.power.PowerUI.class,</span><br><span class="line">        com.android.systemui.media.RingtonePlayer.class,		<span class="comment">//RingtinePlayer服务</span></span><br><span class="line">        com.android.systemui.keyboard.KeyboardUI.class,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startServicesIfNeeded</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = SERVICES.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        Class&lt;?&gt; cl = SERVICES[i];</span><br><span class="line">        mServices[i] = (SystemUI)cl.newInstance();</span><br><span class="line">        mServices[i].mContext = <span class="keyword">this</span>;</span><br><span class="line">        mServices[i].mComponents = mComponents;</span><br><span class="line">        mServices[i].start();									<span class="comment">//启动RingtinePlayer服务</span></span><br><span class="line">        <span class="keyword">if</span> (mBootCompleted) &#123;</span><br><span class="line">            mServices[i].onBootCompleted();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RingtonePlayer是运行在SystemUI进程的服务，RingtonePlayer服务会获取AudioService服务对象，并把IRingtonePlayer对象传给AudioService服务对象中去，其它模块通过AudioService.getRingtonePlayer()来控制RingtonePlayer服务播放提示音的功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> IRingtonePlayer mCallback = <span class="keyword">new</span> IRingtonePlayer.Stub() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">(IBinder token, Uri uri, AudioAttributes aa, <span class="keyword">float</span> volume, <span class="keyword">boolean</span> looping)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        Client client;</span><br><span class="line">        <span class="keyword">synchronized</span> (mClients) &#123;</span><br><span class="line">            client = mClients.get(token);</span><br><span class="line">            <span class="keyword">if</span> (client == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> UserHandle user = Binder.getCallingUserHandle();</span><br><span class="line">                client = <span class="keyword">new</span> Client(token, uri, user, aa);</span><br><span class="line">                token.linkToDeath(client, <span class="number">0</span>);</span><br><span class="line">                mClients.put(token, client);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        client.mRingtone.setLooping(looping);</span><br><span class="line">        client.mRingtone.setVolume(volume);</span><br><span class="line">        client.mRingtone.play();											<span class="comment">//同步播放提示音</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">(IBinder token)</span> </span>&#123;</span><br><span class="line">        Client client;</span><br><span class="line">        <span class="keyword">synchronized</span> (mClients) &#123;</span><br><span class="line">            client = mClients.remove(token);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (client != <span class="keyword">null</span>) &#123;</span><br><span class="line">            client.mToken.unlinkToDeath(client, <span class="number">0</span>);</span><br><span class="line">            client.mRingtone.stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPlaying</span><span class="params">(IBinder token)</span> </span>&#123;</span><br><span class="line">        Client client;</span><br><span class="line">        <span class="keyword">synchronized</span> (mClients) &#123;</span><br><span class="line">            client = mClients.get(token);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (client != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> client.mRingtone.isPlaying();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPlaybackProperties</span><span class="params">(IBinder token, <span class="keyword">float</span> volume, <span class="keyword">boolean</span> looping)</span> </span>&#123;</span><br><span class="line">        Client client;</span><br><span class="line">        <span class="keyword">synchronized</span> (mClients) &#123;</span><br><span class="line">            client = mClients.get(token);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (client != <span class="keyword">null</span>) &#123;</span><br><span class="line">            client.mRingtone.setVolume(volume);</span><br><span class="line">            client.mRingtone.setLooping(looping);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">playAsync</span><span class="params">(Uri uri, UserHandle user, <span class="keyword">boolean</span> looping, AudioAttributes aa)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Binder.getCallingUid() != Process.SYSTEM_UID) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Async playback only available from system UID."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mAsyncPlayer.play(getContextForUser(user), uri, looping, aa);	<span class="comment">//把播放任务放到异步队列中</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopAsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (LOGD) Log.d(TAG, <span class="string">"stopAsync()"</span>);</span><br><span class="line">        <span class="keyword">if</span> (Binder.getCallingUid() != Process.SYSTEM_UID) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Async playback only available from system UID."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mAsyncPlayer.stop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTitle</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> UserHandle user = Binder.getCallingUserHandle();</span><br><span class="line">        <span class="keyword">return</span> Ringtone.getTitle(getContextForUser(user), uri,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/*followSettingsUri*/</span>, <span class="keyword">false</span> <span class="comment">/*allowRemote*/</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">setOnCompletionListener</span><span class="params">(INotificationPlayerOnCompletionListener l)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Binder.getCallingUid() != Process.SYSTEM_UID) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                    <span class="string">"setOnCompletionListener only available from system UID."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mAsyncPlayer.setOnCompletionListener(l);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>如果需要调用异步方式来播放提示音，就需要用到NotificationPlayer这个类，它会把播放任务保存到队列中，通过线程一个一个为队列中每个提示音播放任务创建一个播放线程并执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">/android/frameworks/base/packages/SystemUI/src/com/android/systemui/media/NotificationPlayer.java </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Command</span> </span>&#123;	<span class="comment">//一个异步任务对应一个Command对象</span></span><br><span class="line">    <span class="keyword">int</span> code;</span><br><span class="line">    Context context;</span><br><span class="line">    Uri uri;</span><br><span class="line">    <span class="keyword">boolean</span> looping;</span><br><span class="line">    AudioAttributes attributes;</span><br><span class="line">    <span class="keyword">long</span> requestTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> LinkedList&lt;Command&gt; mCmdQueue = <span class="keyword">new</span> LinkedList();		<span class="comment">//异步任务队列对象</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">(Context context, Uri uri, <span class="keyword">boolean</span> looping, AudioAttributes attributes)</span> </span>&#123;</span><br><span class="line">    Command cmd = <span class="keyword">new</span> Command();</span><br><span class="line">    cmd.requestTime = SystemClock.uptimeMillis();</span><br><span class="line">    cmd.code = PLAY;</span><br><span class="line">    cmd.context = context;</span><br><span class="line">    cmd.uri = uri;</span><br><span class="line">    cmd.looping = looping;</span><br><span class="line">    cmd.attributes = attributes;</span><br><span class="line">    <span class="keyword">synchronized</span> (mCmdQueue) &#123;</span><br><span class="line">        enqueueLocked(cmd);				<span class="comment">//把异步任务加入队列中</span></span><br><span class="line">        mState = PLAY;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enqueueLocked</span><span class="params">(Command cmd)</span> </span>&#123;</span><br><span class="line">    mCmdQueue.add(cmd);					<span class="comment">//把异步任务加入队列对象mCmdQueue中</span></span><br><span class="line">    <span class="keyword">if</span> (mThread == <span class="keyword">null</span>) &#123;				<span class="comment">//如果执行任务线程已经停止，创建线程并开始执行</span></span><br><span class="line">        acquireWakeLock();</span><br><span class="line">        mThread = <span class="keyword">new</span> CmdThread();		<span class="comment">//创建执行任务的线程</span></span><br><span class="line">        mThread.start();				<span class="comment">//启动线程</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CmdThread</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Thread</span> </span>&#123;</span><br><span class="line">    CmdThread() &#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"NotificationPlayer-"</span> + mTag);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Command cmd = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">synchronized</span> (mCmdQueue) &#123;</span><br><span class="line">                cmd = mCmdQueue.removeFirst();	<span class="comment">//取出队列中第一个任务</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (cmd.code) &#123;					<span class="comment">//任务类型</span></span><br><span class="line">            <span class="keyword">case</span> PLAY:							<span class="comment">//播放提示音任务</span></span><br><span class="line">                startSound(cmd);				<span class="comment">//播放提示音</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STOP:							<span class="comment">//停止提示音任务</span></span><br><span class="line">                <span class="keyword">if</span> (mPlayer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">long</span> delay = SystemClock.uptimeMillis() - cmd.requestTime;</span><br><span class="line">                    <span class="keyword">if</span> (delay &gt; <span class="number">1000</span>) &#123;			<span class="comment">//如果异步时间超过1s，打印出来，方便调试</span></span><br><span class="line">                        Log.w(mTag, <span class="string">"Notification stop delayed by "</span> + delay + <span class="string">"msecs"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    mPlayer.stop();</span><br><span class="line">                    mPlayer.release();</span><br><span class="line">                    mPlayer = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">synchronized</span>(mQueueAudioFocusLock) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mAudioManagerWithAudioFocus != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            mAudioManagerWithAudioFocus.abandonAudioFocus(<span class="keyword">null</span>);</span><br><span class="line">                            mAudioManagerWithAudioFocus = <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span>((mLooper != <span class="keyword">null</span>)</span><br><span class="line">                            &amp;&amp; (mLooper.getThread().getState() != Thread.State.TERMINATED)) &#123;</span><br><span class="line">                        mLooper.quit();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Log.w(mTag, <span class="string">"STOP command without a player"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">synchronized</span> (mCmdQueue) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mCmdQueue.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                    mThread = <span class="keyword">null</span>;</span><br><span class="line">                    releaseWakeLock();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startSound</span><span class="params">(Command cmd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(mCompletionHandlingLock) &#123;</span><br><span class="line">            <span class="keyword">if</span>((mLooper != <span class="keyword">null</span>)</span><br><span class="line">                    &amp;&amp; (mLooper.getThread().getState() != Thread.State.TERMINATED)) &#123;</span><br><span class="line">                mLooper.quit();</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">//为每个播放任务创建一个播放提示音线程</span></span><br><span class="line">            mCompletionThread = <span class="keyword">new</span> CreationAndCompletionThread(cmd);</span><br><span class="line">            <span class="keyword">synchronized</span>(mCompletionThread) &#123;</span><br><span class="line">                mCompletionThread.start();	<span class="comment">//开始执行线程</span></span><br><span class="line">                mCompletionThread.wait();	<span class="comment">//等待线程执行完</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> delay = SystemClock.uptimeMillis() - cmd.requestTime;</span><br><span class="line">        <span class="keyword">if</span> (delay &gt; <span class="number">1000</span>) &#123;					<span class="comment">//如果异步时间超过1s，打印出来，方便调试</span></span><br><span class="line">            Log.w(mTag, <span class="string">"Notification sound delayed by "</span> + delay + <span class="string">"msecs"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.w(mTag, <span class="string">"error loading sound for "</span> + cmd.uri, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CreationAndCompletionThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Command mCmd;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CreationAndCompletionThread</span><span class="params">(Command cmd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        mCmd = cmd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Looper.prepare();</span><br><span class="line">        mLooper = Looper.myLooper();</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">            AudioManager audioManager =</span><br><span class="line">                (AudioManager) mCmd.context.getSystemService(Context.AUDIO_SERVICE);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                MediaPlayer player = <span class="keyword">new</span> MediaPlayer();			<span class="comment">//创建一个MediaPlayer对象</span></span><br><span class="line">                player.setAudioAttributes(mCmd.attributes);</span><br><span class="line">                player.setDataSource(mCmd.context, mCmd.uri);</span><br><span class="line">                player.setLooping(mCmd.looping);</span><br><span class="line">                player.prepare();</span><br><span class="line">                <span class="keyword">if</span> ((mCmd.uri != <span class="keyword">null</span>) &amp;&amp; (mCmd.uri.getEncodedPath() != <span class="keyword">null</span>)</span><br><span class="line">                        &amp;&amp; (mCmd.uri.getEncodedPath().length() &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!audioManager.isMusicActiveRemotely()) &#123;</span><br><span class="line">                        <span class="keyword">synchronized</span>(mQueueAudioFocusLock) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (mAudioManagerWithAudioFocus == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (mDebug) Log.d(mTag, <span class="string">"requesting AudioFocus"</span>);</span><br><span class="line">                                <span class="keyword">if</span> (mCmd.looping) &#123;				<span class="comment">//获取长时间音频焦点</span></span><br><span class="line">                                    audioManager.requestAudioFocus(<span class="keyword">null</span>,</span><br><span class="line">                                            AudioAttributes.toLegacyStreamType(mCmd.attributes),</span><br><span class="line">                                            AudioManager.AUDIOFOCUS_GAIN);	</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;						<span class="comment">//获取临时音频焦点</span></span><br><span class="line">                                    audioManager.requestAudioFocus(<span class="keyword">null</span>,</span><br><span class="line">                                            AudioAttributes.toLegacyStreamType(mCmd.attributes),</span><br><span class="line">                                            AudioManager.AUDIOFOCUS_GAIN_TRANSIENT_MAY_DUCK);</span><br><span class="line">                                &#125;</span><br><span class="line">                                mAudioManagerWithAudioFocus = audioManager;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (mDebug) Log.d(mTag, <span class="string">"AudioFocus was previously requested"</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                player.setOnCompletionListener(NotificationPlayer.<span class="keyword">this</span>);</span><br><span class="line">                player.setOnErrorListener(NotificationPlayer.<span class="keyword">this</span>);</span><br><span class="line">                player.start();								<span class="comment">//开始播放提示音</span></span><br><span class="line">                <span class="keyword">if</span> (mPlayer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mPlayer.release();</span><br><span class="line">                &#125;</span><br><span class="line">                mPlayer = player;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Log.w(mTag, <span class="string">"error loading sound for "</span> + mCmd.uri, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.notify();</span><br><span class="line">        &#125;</span><br><span class="line">        Looper.loop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>应用或者服务通过NotificationManager调用notify()发出通过，NotificationManager通过和NotificationManagerService服务通信，调用发出通知，并调用buzzBeepBlinkLocked()方法来触发通知提示音、震动或者led闪烁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line">/android/frameworks/base/core/java/android/app/NotificationManager.java</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(<span class="keyword">int</span> id, Notification notification)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    notify(<span class="keyword">null</span>, id, notification);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(String tag, <span class="keyword">int</span> id, Notification notification)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	INotificationManager service = getService();</span><br><span class="line">    service.enqueueNotificationWithTag(pkg, mContext.getOpPackageName(), tag, id,</span><br><span class="line">            stripped, idOut, UserHandle.myUserId());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/android/frameworks/base/services/core/java/com/android/server/notification/NotificationManagerService.java </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> IBinder mService = <span class="keyword">new</span> INotificationManager.Stub() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueueNotificationWithTag</span><span class="params">(String pkg, String opPkg, String tag, <span class="keyword">int</span> id,</span></span></span><br><span class="line"><span class="function"><span class="params">            Notification notification, <span class="keyword">int</span>[] idOut, <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">        enqueueNotificationInternal(pkg, opPkg, Binder.getCallingUid(),</span><br><span class="line">                Binder.getCallingPid(), tag, id, notification, idOut, userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enqueueNotificationInternal</span><span class="params">(<span class="keyword">final</span> String pkg, <span class="keyword">final</span> String opPkg, <span class="keyword">final</span> <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> callingPid, <span class="keyword">final</span> String tag, <span class="keyword">final</span> <span class="keyword">int</span> id, <span class="keyword">final</span> Notification notification,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span>[] idOut, <span class="keyword">int</span> incomingUserId)</span> </span>&#123;</span><br><span class="line">    mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mNotificationList) &#123;</span><br><span class="line">                <span class="keyword">final</span> StatusBarNotification n = <span class="keyword">new</span> StatusBarNotification(</span><br><span class="line">                        pkg, opPkg, id, tag, callingUid, callingPid, score, notification, user);</span><br><span class="line">                NotificationRecord r = <span class="keyword">new</span> NotificationRecord(n, score);</span><br><span class="line">                NotificationRecord old = mNotificationsByKey.get(n.getKey());</span><br><span class="line">				<span class="comment">//调用服务管理对象mListeners来更新所有注册到mListeners中的NotificationListenerService对象</span></span><br><span class="line">				mListeners.notifyPostedLocked(n, oldSbn);</span><br><span class="line">				<span class="comment">//实现播放notification的提示音，使led灯亮起来或者震动等操作。buzz:嗡嗡叫，beep: 嘟嘟响，blink: 闪烁</span></span><br><span class="line">				buzzBeepBlinkLocked(r);</span><br><span class="line">			&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//实现播放notification的提示音，使led灯亮起来或者震动等操作。buzz:嗡嗡叫，beep: 嘟嘟响，blink: 闪烁</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buzzBeepBlinkLocked</span><span class="params">(NotificationRecord record)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> buzz = <span class="keyword">false</span>;	<span class="comment">//震动</span></span><br><span class="line">    <span class="keyword">boolean</span> beep = <span class="keyword">false</span>;	<span class="comment">//提示音</span></span><br><span class="line">    <span class="keyword">boolean</span> blink = <span class="keyword">false</span>;	<span class="comment">//闪烁</span></span><br><span class="line">    <span class="keyword">final</span> Notification notification = record.sbn.getNotification();</span><br><span class="line">    <span class="comment">// Should this notification make noise, vibe, or use the LED?</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> aboveThreshold = record.score &gt;= SCORE_INTERRUPTION_THRESHOLD;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> canInterrupt = aboveThreshold &amp;&amp; !record.isIntercepted();</span><br><span class="line">    <span class="comment">// If we're not supposed to beep, vibrate, etc. then don't.</span></span><br><span class="line">    <span class="keyword">final</span> String disableEffects = disableNotificationEffects(record);</span><br><span class="line">    <span class="keyword">if</span> (disableEffects != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ZenLog.traceDisableEffects(record, disableEffects);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> smsRingtone = getContext().getResources().getBoolean(</span><br><span class="line">            com.android.internal.R.bool.config_sms_ringtone_incall);</span><br><span class="line">    <span class="keyword">if</span> ((disableEffects == <span class="keyword">null</span> || (smsRingtone &amp;&amp; mInCall))	<span class="comment">//通话期间来短信铃声</span></span><br><span class="line">            &amp;&amp; (!(record.isUpdate</span><br><span class="line">                &amp;&amp; (notification.flags &amp; Notification.FLAG_ONLY_ALERT_ONCE) != <span class="number">0</span> ))</span><br><span class="line">            &amp;&amp; (record.getUserId() == UserHandle.USER_ALL ||</span><br><span class="line">                record.getUserId() == currentUser ||</span><br><span class="line">                mUserProfiles.isCurrentProfile(record.getUserId()))</span><br><span class="line">            &amp;&amp; canInterrupt</span><br><span class="line">            &amp;&amp; mSystemReady</span><br><span class="line">            &amp;&amp; mAudioManager != <span class="keyword">null</span>) &#123;		<span class="comment">//判断是否需要提示音或者震动</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//这里会发出一个Notification的AccessibilityEvent，这样在辅助服务中才能收到这个事件，</span></span><br><span class="line">		<span class="comment">//微信抢红包的功能就是通过这个辅助事件才得以实现的</span></span><br><span class="line">        sendAccessibilityEvent(notification, record.sbn.getPackageName());</span><br><span class="line"></span><br><span class="line">		<span class="comment">//提示音相关</span></span><br><span class="line">        <span class="keyword">if</span>(!isPrayModeNotiOn(mContext)) &#123;		<span class="comment">//判断是否是在祈祷模式下</span></span><br><span class="line">			<span class="comment">//判断Notification是否设置了使用默认提示音或者Notification设置的提示音文件刚好是默认提示音文件</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> useDefaultSound =</span><br><span class="line">                   (notification.defaults &amp; Notification.DEFAULT_SOUND) != <span class="number">0</span> ||</span><br><span class="line">                           Settings.System.DEFAULT_NOTIFICATION_URI</span><br><span class="line">                                   .equals(notification.sound);</span><br><span class="line">            Uri soundUri = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">boolean</span> hasValidSound = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (useDefaultSound) &#123;	<span class="comment">//判断是否使用默认Notification提示音</span></span><br><span class="line">                soundUri = Settings.System.DEFAULT_NOTIFICATION_URI;	<span class="comment">//获取默认提示音Uri</span></span><br><span class="line">                ContentResolver resolver = getContext().getContentResolver();</span><br><span class="line">                hasValidSound = Settings.System.getString(resolver,</span><br><span class="line">                       Settings.System.NOTIFICATION_SOUND) != <span class="keyword">null</span>;		<span class="comment">//默认提示音文件是否有效</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (notification.sound != <span class="keyword">null</span>) &#123;</span><br><span class="line">                soundUri = notification.sound;							<span class="comment">//获取Notification的提示音Uri</span></span><br><span class="line">                hasValidSound = (soundUri != <span class="keyword">null</span>);						<span class="comment">//提示音文件是否有效</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (hasValidSound) &#123;	<span class="comment">//判断是否是有效提示音</span></span><br><span class="line">                <span class="keyword">boolean</span> looping =</span><br><span class="line">                        (notification.flags &amp; Notification.FLAG_INSISTENT) != <span class="number">0</span>;  <span class="comment">//是否设置了循环</span></span><br><span class="line">                AudioAttributes audioAttributes;</span><br><span class="line">                <span class="keyword">if</span> (notification.audioAttributes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    audioAttributes = notification.audioAttributes;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    audioAttributes = Notification.AUDIO_ATTRIBUTES_DEFAULT;</span><br><span class="line">                &#125;</span><br><span class="line">                mSoundNotificationKey = record.getKey();</span><br><span class="line">                <span class="comment">//Notification提示音音量是否为0和音频焦点是否可用</span></span><br><span class="line">                <span class="keyword">if</span> ((mAudioManager.getStreamVolume(</span><br><span class="line">                        AudioAttributes.toLegacyStreamType(audioAttributes)) != <span class="number">0</span>)</span><br><span class="line">                            &amp;&amp; !mAudioManager.isAudioFocusExclusive()) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">						<span class="comment">//-----这里或通过AudioService来获取IRingtonePlayer对象，最终会调用SystemUI进程中的RingtonePlayer来播放提示音</span></span><br><span class="line">                        <span class="keyword">final</span> IRingtonePlayer player = mAudioManager.getRingtonePlayer();	</span><br><span class="line">                        <span class="keyword">if</span> (player != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            player.playAsync(soundUri, record.sbn.getUser(), looping,</span><br><span class="line">                                    audioAttributes);										<span class="comment">//异步方式播放提示音</span></span><br><span class="line">                            beep = <span class="keyword">true</span>;</span><br><span class="line">                            mIsPlaying = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">								<span class="keyword">if</span> (mMethodRingtonePlayer != <span class="keyword">null</span>) &#123;						<span class="comment">//翻转停止播放提示音功能的相关逻辑</span></span><br><span class="line">                                <span class="keyword">if</span> (mOverTurnPlayer != <span class="keyword">null</span> &amp;&amp; mOverTurnPlayer.isEnable() &amp;&amp; !mOverTurnPlayer.isRegister()) &#123;</span><br><span class="line">                                    mOverTurnPlayer.register();</span><br><span class="line">									<span class="comment">//...					//翻转停止播放提示音功能的相关逻辑，这里先不赘述</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        Binder.restoreCallingIdentity(identity);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//震动相关</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> hasCustomVibrate = notification.vibrate != <span class="keyword">null</span>;				<span class="comment">//Notification是否设置震动</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> convertSoundToVibration =</span><br><span class="line">                       !hasCustomVibrate</span><br><span class="line">                    &amp;&amp; hasValidSound</span><br><span class="line">                    &amp;&amp; (mAudioManager.getRingerMode()</span><br><span class="line">                               == AudioManager.RINGER_MODE_VIBRATE);					<span class="comment">//震动模式下，需要把通知提示音变成震动</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> useDefaultVibrate =</span><br><span class="line">                    (notification.defaults &amp; Notification.DEFAULT_VIBRATE) != <span class="number">0</span>;		<span class="comment">//Notification是否设置了默认震动</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> useHaptic = doesItUseHaptic(notification.haptic);				<span class="comment">//Notification是否设置了触屏反馈</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((useDefaultVibrate || convertSoundToVibration || hasCustomVibrate ||useHaptic)</span><br><span class="line">                    &amp;&amp; !(mAudioManager.getRingerMode() == AudioManager.RINGER_MODE_SILENT)) &#123;	<span class="comment">//判断是否需要震动</span></span><br><span class="line">                mVibrateNotificationKey = record.getKey();</span><br><span class="line">                buzz = <span class="keyword">true</span>;	</span><br><span class="line">                doVibrate((useDefaultVibrate || convertSoundToVibration), useHaptic, notification);	<span class="comment">//执行震动</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(beep || buzz) &#123;</span><br><span class="line">            AccessibilityManager accManager = AccessibilityManager.getInstance(getContext());</span><br><span class="line">            accManager.onFlashNotification(record.getNotification().category);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//led灯相关</span></span><br><span class="line">    <span class="keyword">boolean</span> wasShowLights = mLights.remove(record.getKey());</span><br><span class="line">    <span class="keyword">if</span> ((notification.flags &amp; Notification.FLAG_SHOW_LIGHTS) != <span class="number">0</span> &amp;&amp; aboveThreshold) &#123;</span><br><span class="line">        mLights.add(record.getKey());</span><br><span class="line">        updateLightsLocked();		<span class="comment">//更新led灯闪烁</span></span><br><span class="line">        <span class="keyword">if</span> (mUseAttentionLight) &#123;</span><br><span class="line">            mAttentionLight.pulse();</span><br><span class="line">        &#125;</span><br><span class="line">        blink = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (wasShowLights) &#123;</span><br><span class="line">        updateLightsLocked();		<span class="comment">//更新led灯闪烁</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((buzz || beep || blink) &amp;&amp; !isPrayModeNotiOn(mContext)) &#123;</span><br><span class="line">        EventLogTags.writeNotificationAlert(record.getKey(),</span><br><span class="line">                buzz ? <span class="number">1</span> : <span class="number">0</span>, beep ? <span class="number">1</span> : <span class="number">0</span>, blink ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">        mHandler.post(mBuzzBeepBlinked);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doVibrate</span><span class="params">(<span class="keyword">boolean</span> useDefaultVibrate, <span class="keyword">boolean</span> useHaptic, Notification n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (useHaptic) &#123;</span><br><span class="line">        mVibrator.vibrate(n.haptic, -<span class="number">1</span>, <span class="keyword">null</span>,</span><br><span class="line">               Vibrator.MagnitudeTypes.NotificationMagnitude);			<span class="comment">//执行震动</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (useDefaultVibrate) &#123;</span><br><span class="line">        <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mVibrator.vibrate(HapticFeedbackConstants.VIBE_NOTIFICATION, -<span class="number">1</span>, <span class="keyword">null</span>,</span><br><span class="line">                    Vibrator.MagnitudeTypes.NotificationMagnitude);		<span class="comment">//执行震动</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(identity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">long</span> identity2 = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mVibrator.vibrate(n.vibrate, ((n.flags &amp; Notification.FLAG_INSISTENT) != <span class="number">0</span>) ? <span class="number">0</span>: -<span class="number">1</span>, <span class="keyword">null</span>,</span><br><span class="line">                    Vibrator.MagnitudeTypes.NotificationMagnitude);		<span class="comment">//执行震动</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(identity2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NotificationManagerService服务中就是通过AudioService服务获取IRingtonePlayer对象来控制SystemUI进程进行播放提示音的，</p>
<pre><code>final IRingtonePlayer player = mAudioManager.getRingtonePlayer();    
player.playAsync(soundUri, record.sbn.getUser(), looping, audioAttributes);    
</code></pre><p>SystemUI进程播放提示音的流程如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">/android/frameworks/base/packages/SystemUI/src/com/android/systemui/media/RingtonePlayer.java 	</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> NotificationPlayer mAsyncPlayer = <span class="keyword">new</span> NotificationPlayer(TAG);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> IRingtonePlayer mCallback = <span class="keyword">new</span> IRingtonePlayer.Stub() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">playAsync</span><span class="params">(Uri uri, UserHandle user, <span class="keyword">boolean</span> looping, AudioAttributes aa)</span> </span>&#123;</span><br><span class="line">        mAsyncPlayer.play(getContextForUser(user), uri, looping, aa);	<span class="comment">//异步播放提示音</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/android/frameworks/base/packages/SystemUI/src/com/android/systemui/media/NotificationPlayer.java 	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">(Context context, Uri uri, <span class="keyword">boolean</span> looping, AudioAttributes attributes)</span> </span>&#123;</span><br><span class="line">    Command cmd = <span class="keyword">new</span> Command();</span><br><span class="line">    cmd.requestTime = SystemClock.uptimeMillis();</span><br><span class="line">    cmd.code = PLAY;</span><br><span class="line">    cmd.context = context;</span><br><span class="line">    cmd.uri = uri;</span><br><span class="line">    cmd.looping = looping;</span><br><span class="line">    cmd.attributes = attributes;</span><br><span class="line">    <span class="keyword">synchronized</span> (mCmdQueue) &#123;</span><br><span class="line">        enqueueLocked(cmd);							<span class="comment">//把异步播放提示音放到播放任务队列中</span></span><br><span class="line">        mState = PLAY;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enqueueLocked</span><span class="params">(Command cmd)</span> </span>&#123;</span><br><span class="line">    mCmdQueue.add(cmd);</span><br><span class="line">    <span class="keyword">if</span> (mThread == <span class="keyword">null</span>) &#123;</span><br><span class="line">        acquireWakeLock();</span><br><span class="line">        mThread = <span class="keyword">new</span> CmdThread();					<span class="comment">//创建处理队列任务的线程</span></span><br><span class="line">        mThread.start();							<span class="comment">//启动线程开始处理队列中的任务</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CmdThread</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Command cmd = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">synchronized</span> (mCmdQueue) &#123;</span><br><span class="line">                cmd = mCmdQueue.removeFirst();		<span class="comment">//取队列中第一条播放任务</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">switch</span> (cmd.code) &#123;</span><br><span class="line">            <span class="keyword">case</span> PLAY:</span><br><span class="line">                startSound(cmd);					<span class="comment">//开始处理播放提示音任务</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startSound</span><span class="params">(Command cmd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(mCompletionHandlingLock) &#123;</span><br><span class="line">        mCompletionThread = <span class="keyword">new</span> CreationAndCompletionThread(cmd);</span><br><span class="line">		<span class="keyword">synchronized</span>(mCompletionThread) &#123;</span><br><span class="line">			mCompletionThread.start();				<span class="comment">//执行播放提示音线程</span></span><br><span class="line">			mCompletionThread.wait();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CreationAndCompletionThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Command mCmd;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CreationAndCompletionThread</span><span class="params">(Command cmd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        mCmd = cmd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Looper.prepare();</span><br><span class="line">        mLooper = Looper.myLooper();</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				MediaPlayer player = <span class="keyword">new</span> MediaPlayer();</span><br><span class="line">				player.setAudioAttributes(mCmd.attributes);</span><br><span class="line">				player.setDataSource(mCmd.context, mCmd.uri);</span><br><span class="line">				player.setLooping(mCmd.looping);</span><br><span class="line">				player.prepare();</span><br><span class="line">				player.start();						<span class="comment">//播放提示音</span></span><br><span class="line">				<span class="keyword">if</span> (mPlayer != <span class="keyword">null</span>) &#123;</span><br><span class="line">					mPlayer.release();</span><br><span class="line">				&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				Log.w(mTag, <span class="string">"error loading sound for "</span> + mCmd.uri, e);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">this</span>.notify();</span><br><span class="line">		&#125;</span><br><span class="line">		Looper.loop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>要理解Notification框架的原理，需要理清NotificationManager和NotificationManagerService之间是怎么通信的，NotificationManagerService和SystemUI之间是怎么通信的。INotificationManager.Stub不仅作为NotificationManagerService和NotificationManager的远程通信方式，也是NotificationManagerService和SystemUI的远程通信方式，不过SystemUI进程会创建和启动一个系统服务NotificationListenerService，这个系统服务通过INotificationManager.Stub把INotificationListener.Stub对象远程传给NotificationListenerService服务中，让NotificationListenerService服务通过INotificationListener.Stub对象和系统服务NotificationListenerService通信，系统服务NotificationListenerService再调用SystemUI进程来更新UI。</p>
<img src="/2017/03/19/Notification框架简介/通信图.jpg" title="通信图">
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/02/18/23种设计模式的结构图/" rel="next" title="23种设计模式的结构图">
                <i class="fa fa-chevron-left"></i> 23种设计模式的结构图
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/05/08/Git常用命令/" rel="prev" title="Git常用命令">
                Git常用命令 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/touxiang.jpg"
                alt="Evan-Lam" />
            
              <p class="site-author-name" itemprop="name">Evan-Lam</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/liangyunfeng" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/2717692811/profile?topnav=1&wvr=6" target="_blank" title="微博">
                      
                        <i class="fa fa-fw fa-weibo"></i>微博</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.csdn.net/a38876399" title="CSDN" target="_blank">CSDN</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.jianshu.com/u/9f223d7d7208" title="简书" target="_blank">简书</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.csdn.net/Luoshengyang/" title="老罗的Android之旅" target="_blank">老罗的Android之旅</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://chuangzaoshi.com/" title="创建狮" target="_blank">创建狮</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://github.com/google" title="Google" target="_blank">Google</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://androidxref.com/" title="AndroidXRef" target="_blank">AndroidXRef</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#目录"><span class="nav-number">1.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Notification介绍"><span class="nav-number">2.</span> <span class="nav-text">Notification介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#功能作用"><span class="nav-number">2.0.1.</span> <span class="nav-text">功能作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通知的基本组成"><span class="nav-number">2.0.2.</span> <span class="nav-text">通知的基本组成</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Notification框架原理"><span class="nav-number">3.</span> <span class="nav-text">Notification框架原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Notification框架相关的包"><span class="nav-number">3.0.1.</span> <span class="nav-text">Notification框架相关的包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Notification框架的关系类图"><span class="nav-number">3.0.2.</span> <span class="nav-text">Notification框架的关系类图</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Notification框架服务端启动过程"><span class="nav-number">4.</span> <span class="nav-text">Notification框架服务端启动过程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SystemUI进程启动和绑定NotificationManagerService服务端过程："><span class="nav-number">5.</span> <span class="nav-text">SystemUI进程启动和绑定NotificationManagerService服务端过程：</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Notification调用过程"><span class="nav-number">6.</span> <span class="nav-text">Notification调用过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#调用过程如下图所示："><span class="nav-number">6.0.1.</span> <span class="nav-text">调用过程如下图所示：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对应的代码，如以下所示："><span class="nav-number">6.0.2.</span> <span class="nav-text">对应的代码，如以下所示：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Notification通知提示音响起过程"><span class="nav-number">7.</span> <span class="nav-text">Notification通知提示音响起过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#调用过程如下图所示：-1"><span class="nav-number">7.0.1.</span> <span class="nav-text">调用过程如下图所示：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对应的代码，如以下所示：-1"><span class="nav-number">7.0.2.</span> <span class="nav-text">对应的代码，如以下所示：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">8.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Evan-Lam</span>

</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.4"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("JtQ9B4eFwaAAGlGhqHhNeIL3-gzGzoHsz", "IGEWd52BgUrX4IauS8tjzNTL");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
